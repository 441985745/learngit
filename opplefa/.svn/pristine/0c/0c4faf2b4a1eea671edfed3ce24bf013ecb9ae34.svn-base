<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.opple.fa.allocation.dao.AlloctionApproveDAO">
	   <!-- oracle 分页头 -->
    <sql id="pagination_Head" >
        <![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
    </sql>
    <!-- oracle 分页尾 -->
    <sql id="pagination_Tail">
        <![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
    </sql>
    <!-- count * from -->
	<sql id="count_Start_Head">
		<![CDATA[select count(*) from ( ]]>
	</sql>
	<sql id="count_Start_Tail">
		<![CDATA[) countObj ]]>
	</sql>
	<resultMap type="com.opple.fa.allocation.entity.AlloctionApprove" id="alloctionApproveMap">
			<result property="id" column="ID"/>
			<result property="allocationDocument" column="ALLOCATION_DOCUMENT"/>
			<result property="managerCode" column="MANAGER_CODE"/>
			<result property="managerName" column="MANAGER_NAME"/>
			<result property="isConfirm" column="IS_CONFIRM"/>
			<result property="departmentCode" column="DEPARTMENT_CODE"/>
			<result property="departmentName" column="DEPARTMENT_NAME"/>
			<result property="deletedFlag" column="DELETED_FLAG"/>
			<result property="confirmationTime" column="CONFIRMATION_TIME"/>
	</resultMap>
	<insert id="insertAllocationApprove" parameterType="com.opple.fa.allocation.entity.AlloctionApprove">
			insert into TB_FA_ALLOCATION_APPROVE
			(ID,
			ALLOCATION_DOCUMENT,
			MANAGER_CODE,
			MANAGER_NAME,
			IS_CONFIRM,
			DELETED_FLAG
			)values(
			seq_allocation_approve.nextval,
			#{allocationDocument},
			#{managerCode},
			#{managerName},
			#{isConfirm},
			'0'
			)
	</insert>
	<select id="countAllocationApproveBycode" resultType="long" parameterType="com.opple.fa.allocation.entity.AlloctionApprove" >
		select count(*) from TB_FA_ALLOCATION_APPROVE where IS_CONFIRM='1'  and MANAGER_CODE=#{managerCode} and DELETED_FLAG='0'
	</select>
	<select id="serachAlloctionApprove" parameterType="com.opple.fa.allocation.entity.AlloctionApprove" resultMap="alloctionApproveMap">
			select ALLOCATION_DOCUMENT,
			MANAGER_CODE,
			MANAGER_NAME,
			IS_CONFIRM
			from TB_FA_ALLOCATION_APPROVE where MANAGER_CODE=#{managerCode} and IS_CONFIRM='1' and DELETED_FLAG='0'
	</select>
	<select id="serachIsConfirm" resultType="String">
		select IS_CONFIRM from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument} AND DELETED_FLAG='0'
	</select>
	<update id="updateIsConfirm" parameterType="com.opple.fa.allocation.entity.AlloctionApprove">
		update TB_FA_ALLOCATION_APPROVE set
		IS_CONFIRM=${isConfirm},
		CONFIRMATION_TIME=#{confirmationTime}
		where ALLOCATION_DOCUMENT=#{allocationDocument} and (MANAGER_CODE=#{managerCode} or MANAGER_CODE in (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER WHERE CUSERCODE = #{managerCode}))
	</update>
	<update id="updateIsConfirmByBack" parameterType="com.opple.fa.allocation.entity.AlloctionApprove">
		update TB_FA_ALLOCATION_APPROVE set
		IS_CONFIRM='1'
		where ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0'
	</update>
	<select id="getApproveByDocumentAndCode" resultMap="alloctionApproveMap">
			select * from TB_FA_ALLOCATION_APPROVE where (MANAGER_CODE=#{managerCode} or MANAGER_CODE in (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER WHERE CUSERCODE = #{managerCode}))  and ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0'
	</select>
	<update id="deleteAllocationApprove" parameterType="com.opple.fa.allocation.entity.AlloctionApprove">
		update TB_FA_ALLOCATION_APPROVE set DELETED_FLAG='1' where ALLOCATION_DOCUMENT=#{allocationDocument}
		
	</update>
	<select id="serachAlloctionApproveByDocument" parameterType="com.opple.fa.allocation.entity.AlloctionApprove" resultMap="alloctionApproveMap">
		select * from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument}  and DELETED_FLAG='0'
	</select>
	<select id="serachApproveByDocumentAndConfirm" parameterType="com.opple.fa.allocation.entity.AlloctionApprove" resultMap="alloctionApproveMap">
		select * from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0' and IS_CONFIRM='1'
	</select>
	<select id="serachCountConfirmByDocument" resultType="long">
		select count(*) from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0'
	</select>
	<select id="serachCountConfirm" resultType="long">
		select count(*) from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0' and IS_CONFIRM='0'
	</select>
	<select id="serachHistoryPerson" resultMap="alloctionApproveMap" >
		select 	ALLOCATION_DOCUMENT,
				MANAGER_CODE,
				MANAGER_NAME,
				IS_CONFIRM,
				CONFIRMATION_TIME
			from TB_FA_ALLOCATION_APPROVE where ALLOCATION_DOCUMENT=#{allocationDocument} and DELETED_FLAG='0' and CONFIRMATION_TIME is not  null
	</select>
</mapper>