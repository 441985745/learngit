<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.opple.fa.purchase.dao.ReceiveGoodsMappingDAO">
       <!-- oracle 分页头 -->
    <sql id="pagination_Head" >
        <![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
    </sql>
    <!-- oracle 分页尾 -->
    <sql id="pagination_Tail">
        <![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
    </sql>
    <!-- count * from -->
	<sql id="count_Start_Head">
		<![CDATA[select count(*) from ( ]]>
	</sql>
	<sql id="count_Start_Tail">
		<![CDATA[) countObj ]]>
	</sql>
	
	<resultMap id="receiveGoodsMappingResultMap" type="com.opple.fa.purchase.entity.ReceiveGoodsMapping">
		<!-- 申请部门：取 申请单的部门 -->
		<!-- 预算所属部门：取 申请单的预算所属部门 -->
		<result property="cdocument" column="CDOCUMENT"/><!-- 收货单编码 -->
		<result property="receiveGoodsId" column="RECEIVE_GOODS_ID"/><!-- 收货单编码 -->
		<result property="applyCountAll" column="APPLY_COUNT_ALL"/><!-- 订单数量（订单行加和） -->
		<result property="goodsCountAll" column="GOODS_COUNT_ALL"/><!-- 收货数量（订单行加和）  -->
		<result property="applyDate" column="APPLY_DATE" /><!-- -->
		<result property="receiveDate" column="RECEIVE_DATE" /><!-- -->
		<result property="applyDateStart" column="APPLY_DATE_START" /><!-- 申请日期（订单的日期）-->
		<result property="applyDateEnd" column="APPLY_DATE_END" /><!-- 收货单创建的日期-->
		<result property="doProcess" column="DO_PROCESS" /><!-- 代办（默认为：代办，完成就不显示了，1:是，0:否）-->
		<result property="capprovalstate" column="CAPPROVALSTATE" /><!-- 审批状态 -->
		<result property="draft" column="DRAFT" />
		<result property="orderStatus" column="ORDER_STATUS" />
		<result property="purchaseOrderSapId" column="PURCHASE_ORDER_SAP_ID" /><!-- 采购订单号（sap） -->
		<result property="buyerName" column="BUYER_NAME" /><!-- 采购员名称（订单行） -->
		<result property="buyerCode" column="BUYER_CODE" /><!-- 采购员CODE（订单行） -->
		<result property="supplierCode" column="SUPPLIER_CODE" />
		<result property="supplierName" column="SUPPLIER_NAME" />
		<result property="companyCode" column="COMPANY_CODE" />
		<result property="companyName" column="COMPANY_NAME" />
		<result property="costCenter" column="COST_CENTER"/>
		<result property="costCenterCode" column="COST_CENTER_CODE"/><!-- 成本中心 -->
		<result property="assetsType" column="ASSETS_TYPE"/><!-- 资产类型 -->
		<result property="platform" column="PLATFORM"/><!-- 申请部门所属平台 （订单头）-->
		<result property="buyerRemark" column="BUYER_REMARK"/><!-- 采购员备注 -->
		<result property="headerTextDescription" column="HEADER_TEXT_DESCRIPTION"/><!-- 抬头文本说明 （订单头）-->
		<result property="contractNo" column="CONTRACT_NO" /><!-- 合同号（手填） -->
		<result property="applyOrderId" column="APPLY_ORDER_ID" /><!-- 合同号（手填） -->
		<result property="demandOrderId" column="DEMAND_ORDER_ID" /><!-- 合同号（手填） -->

		<result property="applyDepartment" column="APPLY_DEPARTMENT" /><!-- 申请部门(采购申请的部门)-->
		<result property="applyDepartmentCode" column="APPLY_DEPARTMENT_CODE" /><!-- 申请部门code(采购申请的部门)-->
		<result property="budgetDepartmentName" column="BUDGET_DEPARTMENT_NAME" /><!-- 需求部门code(采购申请的预算所属部门)-->
		<result property="budgetDepartmentCode" column="BUDGET_DEPARTMENT_CODE" /><!-- 需求部门(采购申请的预算所属部门)-->
		<result property="officeLocation" column="OFFICE_LOCATION" /><!-- 办公地点(采购申请的办公地点)-->

        <result property="purchaseId" column="PURCHASE_ID" /><!-- 订单编码 -->
		<result property="assetsName" column="ASSETS_NAME"/><!-- 资产名称 -->
		<result property="brand" column="BRAND"/><!-- 规格型号 -->
		<result property="units" column="UNITS"/><!-- 单位（申请单的行） -->
		<result property="applyCount" column="APPLY_COUNT"/><!-- 订单数量（订单行） -->
		<result property="goodsCount" column="GOODS_COUNT"/><!-- 已收货数量（订单行） 然后保存到收货的行里 -->
		<result property="thisGoodsCount" column="THIS_GOODS_COUNT"/><!-- 本次收货数量（手填） -->
		<result property="tax" column="TAX"/><!-- 税率 -->
		<result property="purchaseUnitPrice" column="PURCHASE_UNIT_PRICE"/><!-- 单价（含税） -->
		<result property="purchasePrice" column="PURCHASE_PRICE"/><!-- 总价（含税） -->
		<result property="ledgerAccount" column="LEDGER_ACCOUNT"/><!-- 总账科目 -->
		<result property="deliveryDate" column="DELIVERY_DATE"/><!-- 交货日期 -->
		<result property="requireCheckDate" column="REQUIRE_CHECK_DATE" /><!-- 验收日期(手填) -->
		<result property="recWarrantyPeriod" column="REC_WARRANTY_PERIOD"/><!-- 保固期，手填 -->
		<result property="storageLocation" column="STORAGE_LOCATION" /><!-- 存放位置（手填） -->
		<result property="applyDetailId" column="APPLY_DETAIL_ID" /><!-- 关联字段（隐藏）-->
        <result property="purchaseDetailId" column="PURCHASE_DETAIL_ID"/><!-- 订单明细id -->
		<result property="demandId" column="DEMAND_ID"/><!-- 需求单编码 -->
		<result property="demandDetailId" column="DEMAND_DETAIL_ID"/><!-- 需求单明细编码 -->
		<result property="applyCountDemand" column="APPLY_COUNT_DEMAND"/><!-- 订单需求数量（对应tb_fa_purchase_apply_mapping.apply_count） -->
		<result property="goodsCountDemand" column="GOODS_COUNT_DEMAND"/><!-- 订单需求收货数量（对应tb_fa_purchase_apply_mapping.goods_count） -->
		<result property="checkCountDemand" column="CHECK_COUNT_DEMAND"/><!-- 订单需求收货数量（对应tb_fa_purchase_apply_mapping.goods_count） -->
		<result property="thisGoodsCountDemand" column="THIS_GOODS_COUNT_DEMAND"/><!-- 订单需求收货数量（对应tb_fa_purchase_apply_mapping.goods_count） -->
		<result property="projectCode" column="PROJECT_CODE"/><!-- 项目编码(tb_fa_purchase_apply_mapping) -->
		<result property="functions" column="FUNCTIONS" /><!-- 功能 -->
		<result property="applyDetailId" column="APPLY_DETAIL_ID" /><!-- applyDetailId关联字段（隐藏）-->
		<result property="demandCount" column="DEMAND_COUNT" /><!-- applyDetailId关联字段（隐藏）和sap次级编码的范围一致-->
		<result property="sapMainAssetCode" column="SAP_MAIN_ASSET_CODE"/><!-- sap主编码-->
		<result property="sapSecAssetCode" column="SAP_SEC_ASSET_CODE"/><!-- sap次编码-->
		<result property="sapAssetsCode" column="SAP_ASSETS_CODE"/><!-- sap编码-->
		<result property="checkApplyUser" column="CHECK_APPLY_USER" /><!-- 验收人(默认带出需求单头的申请人) -->
		<result property="checkApplyCode" column="CHECK_APPLY_CODE" /><!-- 验收人(默认带出需求单头的申请人) -->
		<result property="loginUserName" column="LOGIN_USER_NAME"/>
		<result property="loginUserCode" column="LOGIN_USER_CODE"/>
		<result property="specificationParameter" column="SPECIFICATION_PARAMETER"/>
		<result property="periodOfDepreciation" column="DEPRECIATION"/>
		<result property="netSalvage" column="NET_SALVAGE"/>
		<!-- 创建人 创建时间 更新人 更新时间 -->
		<result property="status" column="STATUS" />
		<result property="createBy" column="CREATE_BY" />
		<result property="createDate" column="CREATE_DATE" />
		<result property="updateBy" column="UPDATE_BY" />
		<result property="updateDate" column="UPDATE_DATE" />
		<result property="attachDepartAdminName" column="ATTACH_DEPART_ADMIN_NAME" />
		<result property="attachDepartAdminCode" column="ATTACH_DEPART_ADMIN_CODE" />
<!-- 	SEQ_FA_RECEIVE_CHECK_ID -->
	</resultMap>
<!-- 主界面 -->
	<sql id="search_receiveGoodsMapping_fragment" >
			SELECT V.PURCHASE_ID,
					V.PURCHASE_ORDER_SAP_ID,
			       V.RECEIVE_GOODS_ID,
			       V.COMPANY_CODE,
			       V.COMPANY_NAME,
			       V.SUPPLIER_CODE,
			       V.SUPPLIER_NAME,
			       V.ASSETS_TYPE,
			       V.APPLY_DATE,
			       V.RECEIVE_DATE,
			       V.BUYER_CODE,
			       V.BUYER_NAME,
			       V.APPLY_COUNT_ALL,
			       V.GOODS_COUNT_ALL,
			       V.CAPPROVALSTATE,
			       V.DRAFT,
			       V.STATUS,
			       V.ORDER_STATUS
			  FROM V_FA_RECEIVE_GOODS V
			 WHERE 1 = 1
<!-- 			 and  V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode } -->
		<if
			test="receiveGoodsMapping.draft != null and receiveGoodsMapping.draft != ''">
			AND V.DRAFT = #{receiveGoodsMapping.draft}
		</if>
		<if
				test="receiveGoodsMapping.loginUserName != null and receiveGoodsMapping.loginUserName != ''">
			AND V.BUYER_NAME LIKE '%' || #{receiveGoodsMapping.loginUserName} || '%'
		</if>
		<if
				test="receiveGoodsMapping.loginUserCode != null and receiveGoodsMapping.loginUserCode != ''">
			AND (V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode}
				OR V.BUYER_CODE IN (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER
				WHERE CUSERCODE = #{receiveGoodsMapping.loginUserCode}
				AND SYSDATE BETWEEN CBEGINTIME AND CENDTIME AND CSTATUS='Y' AND CAPPROVALEND='Y')
			OR
			EXISTS(SELECT 1 FROM t_Sys_Userrole TR WHERE TR.CROLECODE=#{receiveGoodsMapping.assetAdminId}
			AND TR.CUSERCODE=#{receiveGoodsMapping.loginUserCode}  AND tr.cstatus='Y')
			)
		</if>
		<if
			test="receiveGoodsMapping.assetsType != null and receiveGoodsMapping.assetsType != ''">
			AND V.ASSETS_TYPE LIKE '%' || #{receiveGoodsMapping.assetsType} || '%' 
		</if>
		<if
			test="receiveGoodsMapping.supplierName != null and receiveGoodsMapping.supplierName != ''">
			AND V.SUPPLIER_NAME LIKE '%' || #{receiveGoodsMapping.supplierName } || '%' 
		</if>
		<if
			test="receiveGoodsMapping.supplierCode != null and receiveGoodsMapping.supplierCode != ''">
			AND V.SUPPLIER_CODE LIKE '%' || #{receiveGoodsMapping.supplierCode } || '%' 
		</if>
		<if
			test="receiveGoodsMapping.capprovalstate != null and receiveGoodsMapping.capprovalstate != ''">
			AND V.CAPPROVALSTATE LIKE '%' || #{receiveGoodsMapping.capprovalstate } || '%' 
		</if>
		<if
			test="receiveGoodsMapping.status != null and receiveGoodsMapping.status != ''">
			AND  V.STATUS LIKE '%' || #{receiveGoodsMapping.status } || '%' 
		</if>
		<if test="receiveGoodsMapping.orderStatus != null and receiveGoodsMapping.orderStatus != ''">
			AND  V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus }
		</if>
		<if
			test="receiveGoodsMapping.purchaseId != null and receiveGoodsMapping.purchaseId != ''">
			AND V.PURCHASE_ID LIKE '%' || #{receiveGoodsMapping.purchaseId } || '%' 
		</if>
		<if
			test="receiveGoodsMapping.receiveGoodsId != null and receiveGoodsMapping.receiveGoodsId != ''">
			AND V.RECEIVE_GOODS_ID LIKE '%' || #{receiveGoodsMapping.receiveGoodsId } || '%' 
		</if>
		<if
			test='receiveGoodsMapping.doProcess == "Y"'>
			AND V.RECEIVE_GOODS_ID IS NULL
		</if>
		<if
			test='receiveGoodsMapping.doProcess == "N"'>
			AND V.RECEIVE_GOODS_ID is not NULL
		</if>
		
		<if
			test="receiveGoodsMapping.applyDateStart != null and receiveGoodsMapping.applyDateStart != ''">
				<![CDATA[	AND V.RECEIVE_DATE >= to_date(#{receiveGoodsMapping.applyDateStart},'yyyy/mm/dd')  ]]>
		</if>
		<if
			test="receiveGoodsMapping.applyDateEnd != null and receiveGoodsMapping.applyDateEnd != ''">
				<![CDATA[	AND V.RECEIVE_DATE <= to_date(#{receiveGoodsMapping.applyDateEnd},'yyyy/mm/dd')  	]]>
		</if>
		ORDER BY V.RECEIVE_GOODS_ID DESC,V.PURCHASE_ID DESC
		</sql>

	<sql id="searchHavingReceived" >
		select
		V.PURCHASE_ID,
		V.PURCHASE_ORDER_SAP_ID,
		V.RECEIVE_GOODS_ID,
		V.COMPANY_CODE,
		V.COMPANY_NAME,
		V.SUPPLIER_CODE,
		V.SUPPLIER_NAME,
		V.ASSETS_TYPE,
		--V.APPLY_DATE,
		V.RECEIVE_DATE,
		V.BUYER_CODE,
		V.BUYER_NAME,
		V.APPLY_COUNT_ALL1 APPLY_COUNT_ALL,
		V.GOODS_COUNT_ALL,
		V.CAPPROVALSTATE,
		V.DRAFT,
		V.STATUS,
		V.ORDER_STATUS
		from (select C.purchase_order_sap_id purchase_order_sap_id,
			A.PURCHASE_ID,
			A.COMPANY_CODE,
			A.COMPANY_NAME,
			A.SUPPLIER_CODE,
			A.SUPPLIER_NAME,
			A.ASSETS_TYPE,
			A.RECEIVE_DATE,
			A.BUYER_CODE,
			A.BUYER_NAME,
			A.CAPPROVALSTATE,
			A.DRAFT,
			A.STATUS,
			A.ORDER_STATUS,
			B.APPLY_COUNT_ALL1,
			B.goods_count_all,
			B.receive_goods_id
		  from tb_fa_receive_goods A
		 inner join (select sum(t.apply_count) APPLY_COUNT_ALL1,
							--sum(t.goods_count) goods_count_all,
							sum(t.this_goods_count) goods_count_all,  --本次收货数量
							t.receive_goods_id
					   from tb_fa_receive_goods_detail t
					  group by t.receive_goods_id) B
			on A.cdocument = B.receive_goods_id
		  left join tb_fa_purchase_order C
			on C.cdocument = A.purchase_id) V
			where 1=1
		<if test="receiveGoodsMapping.orderStatus != null and receiveGoodsMapping.orderStatus != ''">
			<if test="receiveGoodsMapping.orderStatus == '0'" >
				AND  (V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus } or V.ORDER_STATUS is null)
			</if>
			<if test="receiveGoodsMapping.orderStatus == '1'" >
				AND V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus }
			</if>

		</if>
		<if
				test="receiveGoodsMapping.purchaseId != null and receiveGoodsMapping.purchaseId != ''">
			AND V.PURCHASE_ID LIKE '%' || #{receiveGoodsMapping.purchaseId } || '%'
		</if>
		<if
				test="receiveGoodsMapping.companyCode != null and receiveGoodsMapping.companyCode != ''">
			AND V.COMPANY_CODE = #{receiveGoodsMapping.companyCode}
		</if>
		<if
				test="receiveGoodsMapping.receiveGoodsId != null and receiveGoodsMapping.receiveGoodsId != ''">
			AND V.RECEIVE_GOODS_ID LIKE '%' || #{receiveGoodsMapping.receiveGoodsId } || '%'
		</if>


		<if
				test="receiveGoodsMapping.applyDateStart != null and receiveGoodsMapping.applyDateStart != ''">
			<![CDATA[  AND V.RECEIVE_DATE >= to_date(#{receiveGoodsMapping.applyDateStart},'yyyy/mm/dd')  ]]>
		</if>
		<if
				test="receiveGoodsMapping.applyDateEnd != null and receiveGoodsMapping.applyDateEnd != ''">
			<![CDATA[  AND V.RECEIVE_DATE <= to_date(#{receiveGoodsMapping.applyDateEnd},'yyyy/mm/dd')    ]]>
		</if>
		<if
				test="receiveGoodsMapping.draft != null and receiveGoodsMapping.draft != ''">
			AND V.DRAFT = #{receiveGoodsMapping.draft}
		</if>
		<if
				test="receiveGoodsMapping.buyerName != null and receiveGoodsMapping.buyerName != ''">
			AND V.BUYER_NAME LIKE '%' || #{receiveGoodsMapping.buyerName} || '%'
		</if>
		<if
				test="receiveGoodsMapping.assetsType != null and receiveGoodsMapping.assetsType != ''">
			AND V.ASSETS_TYPE LIKE '%' || #{receiveGoodsMapping.assetsType} || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierName != null and receiveGoodsMapping.supplierName != ''">
			AND V.SUPPLIER_NAME LIKE '%' || #{receiveGoodsMapping.supplierName } || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierCode != null and receiveGoodsMapping.supplierCode != ''">
			AND V.SUPPLIER_CODE LIKE '%' || #{receiveGoodsMapping.supplierCode } || '%'
		</if>
		<if
				test="receiveGoodsMapping.capprovalstate != null and receiveGoodsMapping.capprovalstate != ''">
			AND V.CAPPROVALSTATE LIKE '%' || #{receiveGoodsMapping.capprovalstate } || '%'
		</if>
		<if
				test="receiveGoodsMapping.status != null and receiveGoodsMapping.status != ''">
			AND  V.STATUS LIKE '%' || #{receiveGoodsMapping.status } || '%'
		</if>

			AND (V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode}
			OR V.BUYER_CODE IN (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER
			WHERE CUSERCODE = #{receiveGoodsMapping.loginUserCode}
			AND SYSDATE BETWEEN CBEGINTIME AND CENDTIME AND CSTATUS='Y' AND CAPPROVALEND='Y')
			OR
			EXISTS(SELECT 1 FROM t_Sys_Userrole TR WHERE TR.CROLECODE=#{receiveGoodsMapping.assetAdminId}
			AND TR.CUSERCODE=#{receiveGoodsMapping.loginUserCode}  AND tr.cstatus='Y')
			)

		ORDER BY V.RECEIVE_GOODS_ID DESC,V.PURCHASE_ID DESC
	</sql>
	<!-- 管理人员 已收货 查询-->
    <select id="searchReceiveGoodsMapping" resultMap="receiveGoodsMappingResultMap">
        <include refid="pagination_Head" />
        <include refid="searchHavingReceived" />
        <include refid="pagination_Tail" />
		ORDER BY RECEIVE_GOODS_ID DESC,PURCHASE_ID DESC
    </select>
    <select id="searchReceiveGoodsMappingCount" resultType="long">
        <include refid="count_Start_Head" />
        <include refid="searchHavingReceived" />
	    <include refid="count_Start_Tail" />
    </select>


	<sql id="search_allReceiveGoodsMapping_fragment" >
		select
		V.PURCHASE_ID,
		V.PURCHASE_ORDER_SAP_ID,
		V.RECEIVE_GOODS_ID,
		V.COMPANY_CODE,
		V.COMPANY_NAME,
		V.SUPPLIER_CODE,
		V.SUPPLIER_NAME,
		V.ASSETS_TYPE,
		--V.APPLY_DATE,
		V.RECEIVE_DATE,
		V.BUYER_CODE,
		V.BUYER_NAME,
		V.APPLY_COUNT_ALL1 APPLY_COUNT_ALL,
		V.GOODS_COUNT_ALL,
		V.CAPPROVALSTATE,
		V.DRAFT,
		V.STATUS,
		V.ORDER_STATUS
		from (select C.purchase_order_sap_id purchase_order_sap_id,
		A.PURCHASE_ID,
		A.COMPANY_CODE,
		A.COMPANY_NAME,
		A.SUPPLIER_CODE,
		A.SUPPLIER_NAME,
		A.ASSETS_TYPE,
		A.RECEIVE_DATE,
		A.BUYER_CODE,
		A.BUYER_NAME,
		A.CAPPROVALSTATE,
		A.DRAFT,
		A.STATUS,
		A.ORDER_STATUS,
		B.APPLY_COUNT_ALL1,
		B.goods_count_all,
		B.receive_goods_id
		from tb_fa_receive_goods A
		inner join (select sum(t.apply_count) APPLY_COUNT_ALL1,
		sum(t.this_goods_count) goods_count_all,
		t.receive_goods_id
		from tb_fa_receive_goods_detail t
		group by t.receive_goods_id) B
		on A.cdocument = B.receive_goods_id
		left join tb_fa_purchase_order C
		on C.cdocument = A.purchase_id) V
		WHERE 1 = 1
		<!-- 			 and  V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode } -->
		<if
				test="receiveGoodsMapping.draft != null and receiveGoodsMapping.draft != ''">
			AND V.DRAFT = #{receiveGoodsMapping.draft}
		</if>
		<if
				test="receiveGoodsMapping.companyCode != null and receiveGoodsMapping.companyCode != ''">
			AND V.COMPANY_CODE = #{receiveGoodsMapping.companyCode}
		</if>
		<if
				test="receiveGoodsMapping.buyerName != null and receiveGoodsMapping.buyerName != ''">
			AND V.BUYER_NAME LIKE '%' || #{receiveGoodsMapping.buyerName} || '%'
		</if>
		<if
				test="receiveGoodsMapping.buyerCode != null and receiveGoodsMapping.buyerCode != ''">
			AND V.BUYER_CODE in (${receiveGoodsMapping.buyerCode})
		</if>
		<if
				test="receiveGoodsMapping.assetsType != null and receiveGoodsMapping.assetsType != ''">
			AND V.ASSETS_TYPE LIKE '%' || #{receiveGoodsMapping.assetsType} || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierName != null and receiveGoodsMapping.supplierName != ''">
			AND V.SUPPLIER_NAME LIKE '%' || #{receiveGoodsMapping.supplierName } || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierCode != null and receiveGoodsMapping.supplierCode != ''">
			AND V.SUPPLIER_CODE LIKE '%' || #{receiveGoodsMapping.supplierCode } || '%'
		</if>
		<if
				test="receiveGoodsMapping.capprovalstate != null and receiveGoodsMapping.capprovalstate != ''">
			AND V.CAPPROVALSTATE LIKE '%' || #{receiveGoodsMapping.capprovalstate } || '%'
		</if>
		<if
				test="receiveGoodsMapping.status != null and receiveGoodsMapping.status != ''">
			AND  V.STATUS LIKE '%' || #{receiveGoodsMapping.status } || '%'
		</if>
		<if test="receiveGoodsMapping.orderStatus != null and receiveGoodsMapping.orderStatus != ''">
			AND  V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus }
		</if>
		<if
				test="receiveGoodsMapping.purchaseId != null and receiveGoodsMapping.purchaseId != ''">
			AND V.PURCHASE_ID LIKE '%' || #{receiveGoodsMapping.purchaseId } || '%'
		</if>
		<if
				test="receiveGoodsMapping.receiveGoodsId != null and receiveGoodsMapping.receiveGoodsId != ''">
			AND V.RECEIVE_GOODS_ID LIKE '%' || #{receiveGoodsMapping.receiveGoodsId } || '%'
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "Y"'>
			AND V.RECEIVE_GOODS_ID IS NULL
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "N"'>
			AND V.RECEIVE_GOODS_ID is not NULL
		</if>

		<if
				test="receiveGoodsMapping.applyDateStart != null and receiveGoodsMapping.applyDateStart != ''">
			<![CDATA[	AND V.RECEIVE_DATE >= to_date(#{receiveGoodsMapping.applyDateStart},'yyyy/mm/dd')  ]]>
		</if>
		<if
				test="receiveGoodsMapping.applyDateEnd != null and receiveGoodsMapping.applyDateEnd != ''">
			<![CDATA[	AND V.RECEIVE_DATE <= to_date(#{receiveGoodsMapping.applyDateEnd},'yyyy/mm/dd')  	]]>
		</if>
		ORDER BY V.RECEIVE_GOODS_ID DESC,V.PURCHASE_ID DESC
	</sql>
	<select id="searchAllReceiveGoodsMapping" resultMap="receiveGoodsMappingResultMap">
		<include refid="pagination_Head" />
		<include refid="search_allReceiveGoodsMapping_fragment" />
		<include refid="pagination_Tail" />
		ORDER BY RECEIVE_GOODS_ID DESC,PURCHASE_ID DESC
	</select>
	<select id="searchAllReceiveGoodsMappingCount" resultType="long">
		<include refid="count_Start_Head" />
		<include refid="search_allReceiveGoodsMapping_fragment" />
		<include refid="count_Start_Tail" />
	</select>


	<!-- 待收货的单据 采购经理-->
	<sql id="search_allReceiveGoodsMapping_forReceive_all" >
		SELECT * FROM  (SELECT M.PURCHASE_ID,
		M.PURCHASE_ORDER_SAP_ID,
		''    RECEIVE_GOODS_ID,

		'' receive_date,
		M.COMPANY_CODE,
		M.COMPANY_NAME,
		M.SUPPLIER_CODE,
		M.SUPPLIER_NAME,
		M.ASSET_TYPE    ASSETS_TYPE,
		M.APPLY_DATE,
		M.BUYER_CODE,
		M.BUYER_NAME,
		M.APPLY_COUNT APPLY_COUNT_ALL,
		M.GOODS_COUNT GOODS_COUNT_ALL,
		'' CAPPROVALSTATE,
		'' DRAFT,
		--DECODE(RG.CDOCUMENT, NULL, NULL, '', '', RG.CREATE_DATE) APPLY_DATE, --收货单创建的日期
		'0' STATUS,
		'' ORDER_STATUS
		FROM (--从订单主表中查询数据，并关联详情表中查询出来的同一订单号所申请购买数量合计，收货数量合计（收货时更新此表）
		SELECT PO.CDOCUMENT PURCHASE_ID,
		PO.PURCHASE_ORDER_SAP_ID,
		PO.ASSET_TYPE,
		PO.APPLY_DATE,
		PO.COMPANY_CODE,
		PO.COMPANY_NAME,
		PO.SUPPLIER_CODE,
		PO.SUPPLIER_NAME,
		PO.ORDER_STATUS,
		PO.CAPPROVALSTATE,
		PO.DRAFT,
		PO.BUYER_CODE,
		PO.BUYER_NAME,
		L.APPLY_COUNT,
		L.GOODS_COUNT
		FROM TB_FA_PURCHASE_ORDER PO,
		(--从订单详情单中根据订单主表ID分组，查询订单ID,本次申请数量合计，收货数量合计
		SELECT POD.PURCHASE_ORDER_ID,
		SUM(POD.APPLY_COUNT) APPLY_COUNT,
		SUM(NVL(POD.GOODS_COUNT, 0)) GOODS_COUNT
		FROM TB_FA_PURCHASE_ORDER_DETAIL POD
		--where pod.purchase_order_id='CGDD2017031275'
		GROUP BY POD.PURCHASE_ORDER_ID ) L
		WHERE 1 = 1
		and CAPPROVALSTATE = '已完成'
		and PO.Order_Status='未关闭'
		and PO.Draft = 'N'
		AND L.PURCHASE_ORDER_ID = PO.CDOCUMENT) M

		WHERE M.APPLY_COUNT !=  M.GOODS_COUNT) V
		WHERE 1 = 1
		<!-- 			 and  V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode } -->
		<if
				test="receiveGoodsMapping.draft != null and receiveGoodsMapping.draft != ''">
			AND V.DRAFT = #{receiveGoodsMapping.draft}
		</if>
		<if
				test="receiveGoodsMapping.companyCode != null and receiveGoodsMapping.companyCode != ''">
			AND V.COMPANY_CODE = #{receiveGoodsMapping.companyCode}
		</if>
		<if
				test="receiveGoodsMapping.buyerName != null and receiveGoodsMapping.buyerName != ''">
			AND V.BUYER_NAME LIKE '%' || #{receiveGoodsMapping.buyerName} || '%'
		</if>
		<if
				test="receiveGoodsMapping.buyerCode != null and receiveGoodsMapping.buyerCode != ''">
			AND V.BUYER_CODE in (${receiveGoodsMapping.buyerCode})
		</if>
		<if
				test="receiveGoodsMapping.assetsType != null and receiveGoodsMapping.assetsType != ''">
			AND V.ASSETS_TYPE LIKE '%' || #{receiveGoodsMapping.assetsType} || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierName != null and receiveGoodsMapping.supplierName != ''">
			AND V.SUPPLIER_NAME LIKE '%' || #{receiveGoodsMapping.supplierName } || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierCode != null and receiveGoodsMapping.supplierCode != ''">
			AND V.SUPPLIER_CODE LIKE '%' || #{receiveGoodsMapping.supplierCode } || '%'
		</if>
		<if
				test="receiveGoodsMapping.capprovalstate != null and receiveGoodsMapping.capprovalstate != ''">
			AND V.CAPPROVALSTATE LIKE '%' || #{receiveGoodsMapping.capprovalstate } || '%'
		</if>
		<if
				test="receiveGoodsMapping.status != null and receiveGoodsMapping.status != ''">
			AND  V.STATUS LIKE '%' || #{receiveGoodsMapping.status } || '%'
		</if>
		<if test="receiveGoodsMapping.orderStatus != null and receiveGoodsMapping.orderStatus != ''">
			AND  V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus }
		</if>
		<if
				test="receiveGoodsMapping.purchaseId != null and receiveGoodsMapping.purchaseId != ''">
			AND V.PURCHASE_ID LIKE '%' || #{receiveGoodsMapping.purchaseId } || '%'
		</if>
		<if
				test="receiveGoodsMapping.receiveGoodsId != null and receiveGoodsMapping.receiveGoodsId != ''">
			AND V.RECEIVE_GOODS_ID LIKE '%' || #{receiveGoodsMapping.receiveGoodsId } || '%'
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "Y"'>
			AND V.RECEIVE_GOODS_ID IS NULL
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "N"'>
			AND V.RECEIVE_GOODS_ID is not NULL
		</if>

		<if
				test="receiveGoodsMapping.applyDateStart != null and receiveGoodsMapping.applyDateStart != ''">
			<![CDATA[	AND V.RECEIVE_DATE >= to_date(#{receiveGoodsMapping.applyDateStart},'yyyy/mm/dd')  ]]>
		</if>
		<if
				test="receiveGoodsMapping.applyDateEnd != null and receiveGoodsMapping.applyDateEnd != ''">
			<![CDATA[	AND V.RECEIVE_DATE <= to_date(#{receiveGoodsMapping.applyDateEnd},'yyyy/mm/dd')  	]]>
		</if>
		ORDER BY V.RECEIVE_GOODS_ID DESC,V.PURCHASE_ID DESC
	</sql>

	<select id="searchReceiveGoodsMappingForReceiveAll" resultMap="receiveGoodsMappingResultMap">
		<include refid="pagination_Head" />
		<include refid="search_allReceiveGoodsMapping_forReceive_all" />
		<include refid="pagination_Tail" />
		ORDER BY RECEIVE_GOODS_ID DESC,PURCHASE_ID DESC
	</select>
	<select id="searchReceiveGoodsMappingForReceiveAllCount" resultType="long">
		<include refid="count_Start_Head" />
		<include refid="search_allReceiveGoodsMapping_forReceive_all" />
		<include refid="count_Start_Tail" />
	</select>
	<select id="exportReceive1" resultMap="receiveGoodsMappingResultMap">
		<include refid="search_allReceiveGoodsMapping_forReceive_all" />
	</select>

	<select id="export1ReceiveHavingReceived" resultMap="receiveGoodsMappingResultMap">
		<include refid="search_allReceiveGoodsMapping_fragment" />
	</select>
	<!-- 待收货的单据 采购员-->
	<sql id="search_allReceiveGoodsMapping_forReceive" >
		SELECT * FROM  (SELECT M.PURCHASE_ID,
		M.PURCHASE_ORDER_SAP_ID,
		''    RECEIVE_GOODS_ID,

		'' receive_date,
		M.COMPANY_CODE,
		M.COMPANY_NAME,
		M.SUPPLIER_CODE,
		M.SUPPLIER_NAME,
		M.ASSET_TYPE    ASSETS_TYPE,
		M.APPLY_DATE,
		M.BUYER_CODE,
		M.BUYER_NAME,
		M.APPLY_COUNT APPLY_COUNT_ALL,
		M.GOODS_COUNT GOODS_COUNT_ALL,
		'' CAPPROVALSTATE,
		'' DRAFT,
		--DECODE(RG.CDOCUMENT, NULL, NULL, '', '', RG.CREATE_DATE) APPLY_DATE, --收货单创建的日期
		'0' STATUS,
		'' ORDER_STATUS
		FROM (--从订单主表中查询数据，并关联详情表中查询出来的同一订单号所申请购买数量合计，收货数量合计（收货时更新此表）
		SELECT PO.CDOCUMENT PURCHASE_ID,
		PO.PURCHASE_ORDER_SAP_ID,
		PO.ASSET_TYPE,
		PO.APPLY_DATE,
		PO.COMPANY_CODE,
		PO.COMPANY_NAME,
		PO.SUPPLIER_CODE,
		PO.SUPPLIER_NAME,
		PO.ORDER_STATUS,
		PO.CAPPROVALSTATE,
		PO.DRAFT,
		PO.BUYER_CODE,
		PO.BUYER_NAME,
		L.APPLY_COUNT,
		L.GOODS_COUNT
		FROM TB_FA_PURCHASE_ORDER PO,
		(--从订单详情单中根据订单主表ID分组，查询订单ID,本次申请数量合计，收货数量合计
		SELECT POD.PURCHASE_ORDER_ID,
		SUM(POD.APPLY_COUNT) APPLY_COUNT,
		SUM(NVL(POD.GOODS_COUNT, 0)) GOODS_COUNT
		FROM TB_FA_PURCHASE_ORDER_DETAIL POD
		--where pod.purchase_order_id='CGDD2017031275'
		GROUP BY POD.PURCHASE_ORDER_ID ) L
		WHERE 1 = 1
		and CAPPROVALSTATE = '已完成'
		and PO.Order_Status='未关闭'
		and PO.Draft = 'N'
		AND L.PURCHASE_ORDER_ID = PO.CDOCUMENT) M

		WHERE M.APPLY_COUNT !=  M.GOODS_COUNT) V
		WHERE 1 = 1
		<!-- 			 and  V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode } -->
		<if
				test="receiveGoodsMapping.draft != null and receiveGoodsMapping.draft != ''">
			AND V.DRAFT = #{receiveGoodsMapping.draft}
		</if>
		<if
				test="receiveGoodsMapping.companyCode != null and receiveGoodsMapping.companyCode != ''">
			AND V.COMPANY_CODE = #{receiveGoodsMapping.companyCode}
		</if>
		<if
				test="receiveGoodsMapping.buyerName != null and receiveGoodsMapping.buyerName != ''">
			AND V.BUYER_NAME LIKE '%' || #{receiveGoodsMapping.buyerName} || '%'
		</if>

		<if
				test="receiveGoodsMapping.assetsType != null and receiveGoodsMapping.assetsType != ''">
			AND V.ASSETS_TYPE LIKE '%' || #{receiveGoodsMapping.assetsType} || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierName != null and receiveGoodsMapping.supplierName != ''">
			AND V.SUPPLIER_NAME LIKE '%' || #{receiveGoodsMapping.supplierName } || '%'
		</if>
		<if
				test="receiveGoodsMapping.supplierCode != null and receiveGoodsMapping.supplierCode != ''">
			AND V.SUPPLIER_CODE LIKE '%' || #{receiveGoodsMapping.supplierCode } || '%'
		</if>
		<if
				test="receiveGoodsMapping.capprovalstate != null and receiveGoodsMapping.capprovalstate != ''">
			AND V.CAPPROVALSTATE LIKE '%' || #{receiveGoodsMapping.capprovalstate } || '%'
		</if>
		<if
				test="receiveGoodsMapping.status != null and receiveGoodsMapping.status != ''">
			AND  V.STATUS LIKE '%' || #{receiveGoodsMapping.status } || '%'
		</if>
		<if test="receiveGoodsMapping.orderStatus != null and receiveGoodsMapping.orderStatus != ''">
			AND  V.ORDER_STATUS = #{receiveGoodsMapping.orderStatus }
		</if>
		<if
				test="receiveGoodsMapping.purchaseId != null and receiveGoodsMapping.purchaseId != ''">
			AND V.PURCHASE_ID LIKE '%' || #{receiveGoodsMapping.purchaseId } || '%'
		</if>
		<if
				test="receiveGoodsMapping.receiveGoodsId != null and receiveGoodsMapping.receiveGoodsId != ''">
			AND V.RECEIVE_GOODS_ID LIKE '%' || #{receiveGoodsMapping.receiveGoodsId } || '%'
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "Y"'>
			AND V.RECEIVE_GOODS_ID IS NULL
		</if>
		<if
				test='receiveGoodsMapping.doProcess == "N"'>
			AND V.RECEIVE_GOODS_ID is not NULL
		</if>

		<if
				test="receiveGoodsMapping.applyDateStart != null and receiveGoodsMapping.applyDateStart != ''">
			<![CDATA[	AND V.RECEIVE_DATE >= to_date(#{receiveGoodsMapping.applyDateStart},'yyyy/mm/dd')  ]]>
		</if>
		<if
				test="receiveGoodsMapping.applyDateEnd != null and receiveGoodsMapping.applyDateEnd != ''">
			<![CDATA[	AND V.RECEIVE_DATE <= to_date(#{receiveGoodsMapping.applyDateEnd},'yyyy/mm/dd')  	]]>
		</if>
		AND (V.BUYER_CODE = #{receiveGoodsMapping.loginUserCode}
			OR V.BUYER_CODE IN (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER
				WHERE CUSERCODE = #{receiveGoodsMapping.loginUserCode}
				AND SYSDATE BETWEEN CBEGINTIME AND CENDTIME AND CSTATUS='Y' AND CAPPROVALEND='Y')
			OR
			EXISTS(SELECT 1 FROM t_Sys_Userrole TR WHERE TR.CROLECODE=#{receiveGoodsMapping.assetAdminId}
				AND TR.CUSERCODE=#{receiveGoodsMapping.loginUserCode}  AND tr.cstatus='Y')
		)
		ORDER BY V.RECEIVE_GOODS_ID DESC,V.PURCHASE_ID DESC

	</sql>
	<select id="searchReceiveGoodsMappingForReceive" resultMap="receiveGoodsMappingResultMap">
		<include refid="pagination_Head" />
		<include refid="search_allReceiveGoodsMapping_forReceive" />
		<include refid="pagination_Tail" />
		ORDER BY RECEIVE_GOODS_ID DESC,PURCHASE_ID DESC
	</select>

	<select id="searchReceiveGoodsMappingForReceiveCount" resultType="long">
		<include refid="count_Start_Head" />
		<include refid="search_allReceiveGoodsMapping_forReceive" />
		<include refid="count_Start_Tail" />
	</select>
	<!-- 采购员待收货-->
	<select id="exportReceive" resultMap="receiveGoodsMappingResultMap">
		<include refid="search_allReceiveGoodsMapping_forReceive" />
	</select>
	<!-- 采购员已收货-->
	<select id="exportReceiveHavingReceived" resultMap="receiveGoodsMappingResultMap">
		<include refid="searchHavingReceived" />
	</select>


<!-- 收货单头  查询 收货时page3页面的头信息-->
	<select id="searchPurchaseOrderMappingByPurchaseId" resultMap="receiveGoodsMappingResultMap">
    	    SELECT DISTINCT H.CDOCUMENT,
			                H.BUYER_CODE, -- 采购员名称（订单行） 
			                H.BUYER_NAME,
			                H.SUPPLIER_CODE,
			                H.SUPPLIER_NAME,
			                H.COMPANY_CODE,
			                H.COMPANY_NAME,
			                H.COST_CENTER,
			                H.COST_CENTER_CODE, --成本中心
			                H.ASSET_TYPE ASSETS_TYPE, --资产类型 
			                H.PLATFORM, -- 申请部门所属平台 （订单头）
			                H.BUYER_REMARK, --采购员备注
			                H.CDOCUMENT AS PURCHASE_ID, --订单编码f
			                H.HEADER_TEXT_DESCRIPTION, --抬头文本说明 （订单头）
					        AO.APPLY_DEPARTMENT, --
		                    AO.APPLY_DEPARTMENT_CODE, --
		                    --AO.BUDGET_DEPARTMENT_CODE,需求部门
		                    --AO.BUDGET_DEPARTMENT_NAME,
		                    H.OFFICE_LOCATION


			  FROM TB_FA_PURCHASE_ORDER        H,
			       TB_FA_PURCHASE_ORDER_DETAIL POD,
			       TB_FA_APPLY_ORDER_DETAIL    AOD,
			       TB_FA_APPLY_ORDER           AO
			 WHERE 1 = 1
			   AND POD.PURCHASE_ORDER_ID = H.CDOCUMENT
			   AND POD.APPLY_DETAIL_ID = AOD.ID
			   AND AO.CDOCUMENT = AOD.APPLY_ORDER_ID
			AND H.CDOCUMENT = #{purchaseId }
			--and roenum = 1
	</select>
	
<!-- 收货单行 查询  -->
	<select id="searchPurchaseOrderDetailMappingByPurchaseId" resultMap="receiveGoodsMappingResultMap" >
<!-- 			SELECT  -->
<!-- 			       L.PURCHASE_ORDER_ID PURCHASE_ID, -->
<!-- 			       L.ID PURCHASE_DETAIL_ID,  -->
<!-- 			       L.APPLY_DETAIL_ID, -->
<!-- 				   L.ASSETS_NAME, -->
<!-- 			       L.APPLY_COUNT,  -->
<!-- 			       NVL(L.GOODS_COUNT, 0) GOODS_COUNT, -->
<!-- 			       (L.APPLY_COUNT - NVL(L.GOODS_COUNT, 0)) THIS_GOODS_COUNT,  -->
<!-- 			       L.TAX, -->
<!-- 			       L.PURCHASE_UNIT_PRICE,  -->
<!-- 			       L.PURCHASE_PRICE  -->
<!-- 			  FROM TB_FA_PURCHASE_ORDER_DETAIL L -->
<!-- 			 WHERE 1 = 1 -->

		SELECT DISTINCT
		L.PURCHASE_ORDER_ID PURCHASE_ID,
		L.ID PURCHASE_DETAIL_ID, --订单明细ID
		L.APPLY_DETAIL_ID,
		L.ASSETS_NAME,
		L.APPLY_COUNT,                                            --订单数量（订单行）
		NVL(L.GOODS_COUNT, 0) GOODS_COUNT,                        --已收货数量（订单行） 然后保存到收货的行里
		(L.APPLY_COUNT - NVL(L.GOODS_COUNT, 0)) THIS_GOODS_COUNT, --本次收货数量（手填）
		--L.TAX,                                                    --税率
		L.PURCHASE_UNIT_PRICE,                                    --单价（含税）
		L.PURCHASE_PRICE,                                         --总价（含税）
		L.APPLY_ORDER_ID,

		--RGD.DELIVERY_DATE,
		--RGD.REQUIRE_CHECK_DATE,
		--RGD.REC_WARRANTY_PERIOD,
		--RGD.STORAGE_LOCATION,
		--RGD.UNITS,
		--RGD.LEDGER_ACCOUNT,
		--RGD.ASSETS_TYPE
		PO.LEDGER_ACCOUNT, --总账科目,
		L.WARRANTY_PERIOD REC_WARRANTY_PERIOD, --质保周期,

		AOD.UNITS --单位
		--     dod.DEMAND_ORDER_ID,
		--     AOD.SPECIFICATION_PARAMETER,
		--     aod.DEPRECIATION,
		--     AOD.NET_SALVAGE

		FROM TB_FA_PURCHASE_ORDER_DETAIL L
		LEFT JOIN TB_FA_RECEIVE_GOODS_DETAIL RGD
		ON RGD.APPLY_DETAIL_ID = L.APPLY_DETAIL_ID
		LEFT JOIN Tb_Fa_Apply_Demand_Mapping ADM
		ON L.APPLY_ORDER_ID = ADM.APPLY_ID
		LEFT JOIN TB_FA_DEMAND_ORDER_DETAIL DOD
		ON ADM.DEMAND_DETAIL_ID = DOD.ID
		LEFT join TB_FA_APPLY_ORDER_DETAIL AOD
		ON L.APPLY_DETAIL_ID = AOD.ID
		left join tb_fa_purchase_order PO
		ON PO.CDOCUMENT = L.PURCHASE_ORDER_ID
		WHERE 1                 = 1
		AND L.PURCHASE_ORDER_ID = #{purchaseId }
-- 		and RGD.ASSETS_TYPE is not null
	</select>
	<select id="searchDemandMappingByPurchaseId" resultMap="receiveGoodsMappingResultMap">
	SELECT DISTINCT dod.DEMAND_ORDER_ID
	FROM TB_FA_APPLY_DEMAND_MAPPING adm
	LEFT JOIN
	  (SELECT DISTINCT id,DEMAND_ORDER_ID FROM TB_FA_DEMAND_ORDER_DETAIL
	  ) dod
	ON adm.DEMAND_DETAIL_ID = dod.ID
	WHERE 1                 = 1
	AND APPLY_ID            = #{applyOrderId}
	</select>

	<!--  SYSDATE   DELIVERY_DATE, 交货日期（默认当前日期为交货日期） -->
	<!--  更改收货数量    需求明细   查询全部 -->  
	<select id="searchPurchaseApplyMappingByPurchaseId" resultMap="receiveGoodsMappingResultMap">
		    SELECT DISTINCT M.ASSETS_NAME,
			  DOD.ASSET_TYPE ASSETS_TYPE,
			  DOD.SPECIFICATION_PARAMETER BRAND,							   --规格型号
			  DOD.FUNCTIONS,
			  DOD.DEMAND_ORDER_ID DEMAND_ID,                                   --需求单编码
			  M.DEMAND_DETAIL_ID,                                              --需求单明细编码
			  M.APPLY_COUNT APPLY_COUNT_DEMAND,                                --订单需求数量
			  NVL(M.GOODS_COUNT, 0) GOODS_COUNT_DEMAND,                        --订单需求已经收货数量
			  (M.APPLY_COUNT - NVL(M.GOODS_COUNT, 0)) THIS_GOODS_COUNT_DEMAND, --订单未收货数量
			  M.PROJECT_CODE,                                                  --项目编码
			  M.PURCHASE_ID,
			  POD.ID PURCHASE_DETAIL_ID,
			  M.APPLY_DETAIL_ID
			FROM TB_FA_PURCHASE_APPLY_MAPPING M,
			  TB_FA_DEMAND_ORDER_DETAIL DOD,
			  TB_FA_PURCHASE_ORDER_DETAIL POD
			WHERE 1                   = 1
			AND DOD.ID                = M.DEMAND_DETAIL_ID
			AND POD.PURCHASE_ORDER_ID = M.PURCHASE_ID
			AND POD.APPLY_DETAIL_ID   = M.APPLY_DETAIL_ID
			AND M.PURCHASE_ID         = #{purchaseId }
	</select>
	
	<!-- 查新公共表里的sap次级编码 ，为下面的不显示资产编码-->
	<select id="searchPurchaseCommonSapAssetsCodeByPurchaseId" resultMap="receiveGoodsMappingResultMap">
			SELECT PC.DEMAND_ID,
			       PC.DEMAND_DETAIL_ID,
			       PC.PURCHASE_ID,
			       PC.PURCHASE_DETAIL_ID,
			       PC.APPLY_DETAIL_ID,
			       PC.ASSETS_NAME,
			       PC.SAP_ASSETS_CODE,
			       PC.SAP_MAIN_ASSET_CODE,
			       PC.SAP_SEC_ASSET_CODE,
			       PC.BRAND,
			       PC.FUNCTIONS
			  FROM TB_FA_PURCHASE_COMMON PC
			 WHERE 1 = 1
			   AND PC.PURCHASE_ID = #{purchaseId } 
	</select>

	<!-- 资产编码 sap次级拆分后的查询 -->
	<select id="searchSapAssetsCodeByPurchaseId" resultMap="receiveGoodsMappingResultMap">
		SELECT E.PURCHASE_ID,
		       E.PURCHASE_DETAIL_ID,
	           ltrim(rtrim(E.ASSET_NO)) SAP_MAIN_ASSET_CODE,
    	       ltrim(rtrim(E.SUB_NUMBER)) SAP_SEC_ASSET_CODE,
		       decode(E.SUB_NUMBER,'','',NULL,NULL,(rtrim(E.ASSET_NO) || '-' || lpad(ltrim(rtrim(e.sub_number)),4,0))) SAP_ASSETS_CODE --sap编码
		  FROM TB_FA_SAP_PURCHASE_ORDER E
		 WHERE 1 = 1
		   AND E.PURCHASE_ID =  #{purchaseId } 
	    ORDER BY E.PURCHASE_ID,E.PURCHASE_DETAIL_ID,E.SUB_NUMBER
	</select>

	<!-- 查询需求单号 分配给对应的sap次级编码 -->
	<select id="searchDemandIdByPurchaseId" resultMap="receiveGoodsMappingResultMap">
		  SELECT POD.PURCHASE_ORDER_ID 	PURCHASE_ID,
		         POD.ID 				PURCHASE_DETAIL_ID,
		         POD.APPLY_DETAIL_ID,
		         M.APPLY_COUNT 			DEMAND_COUNT,
		         DOD.DEMAND_ORDER_ID 	DEMAND_ID,
		         DOD.ID 				DEMAND_DETAIL_ID,
		         DECODE(DOD.ASSET_TYPE,
		                'IT资产',
		                AO.APPLY_USER_CODE,
		                DO.APPLY_USER_CODE) CHECK_APPLY_CODE,
		         DECODE(DOD.ASSET_TYPE, 'IT资产', AO.APPLY_USER, DO.APPLY_USER) CHECK_APPLY_USER,
		         --   DECODE(DOD.ASSET_TYPE,'IT资产','采购申请人','需求申请人'),
		         DOD.ASSET_TYPE,
		         DOD.ASSETS_NAME,
		         POD.BRAND, --规格型号
		         DOD.FUNCTIONS,
		         DO.BUDGET_DEPARTMENT_CODE,
		         DO.BUDGET_DEPARTMENT_NAME,
		         DO.COST_CENTER_CODE,
		         DO.COST_CENTER
		   FROM TB_FA_PURCHASE_ORDER_DETAIL  POD,
		         TB_FA_PURCHASE_APPLY_MAPPING M,
		         TB_FA_DEMAND_ORDER_DETAIL    DOD,
		         TB_FA_DEMAND_ORDER           DO,
		         TB_FA_APPLY_ORDER            AO,
		         TB_FA_APPLY_ORDER_DETAIL     AOD
		   WHERE 1 = 1
		     AND DOD.ID = M.DEMAND_DETAIL_ID
		     AND M.PURCHASE_ID = POD.PURCHASE_ORDER_ID
		     AND M.APPLY_DETAIL_ID = POD.APPLY_DETAIL_ID
		     AND DO.CDOCUMENT = DOD.DEMAND_ORDER_ID
		     AND AO.CDOCUMENT = AOD.APPLY_ORDER_ID
		     AND M.APPLY_DETAIL_ID = AOD.ID
             AND POD.PURCHASE_ORDER_ID = #{purchaseId }
             order by POD.PURCHASE_ORDER_ID,POD.ID
	</select>
	<!-- 存放位置弹框 -->
	<select id="searchStorageLocationByOfficeLocation" resultMap="receiveGoodsMappingResultMap">
	SELECT P.CPOSITION STORAGE_LOCATION,--存放位置
	       P.WORK_ADDRESS OFFICE_LOCATION--办公地点
	  FROM TB_FA_POSITION P
	 WHERE CSTATUS='Y'
	   	<if
			test="storageLocation != null and storageLocation != ''">
			AND P.CPOSITION LIKE '%' || #{storageLocation} || '%' 
		</if>
	   	<if
			test="officeLocation != null and officeLocation != ''">
			AND P.WORK_ADDRESS LIKE '%' || #{officeLocation} || '%' 
		</if>
		
	</select>
	
	
	<!-- 保存到需求明细表(TB_FA_RECEIVE_CHECK_MAPPING)，验收时要用 -->
	<insert id="saveReceiveCheckMapping" keyProperty="id" useGeneratedKeys="true">
		<selectKey keyProperty="id" order="BEFORE" resultType="long">
			SELECT SEQ_FA_RECEIVE_CHECK_ID.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_FA_RECEIVE_CHECK_MAPPING RCM
		  (RCM.ID,
		   RCM.RECEIVE_GOODS_ID,
		   RCM.DEMAND_ID,
		   RCM.DEMAND_DETAIL_ID,
		   RCM.PURCHASE_ID,
		   RCM.PURCHASE_DETAIL_ID,
		   RCM.APPLY_DETAIL_ID,
		   RCM.ASSETS_NAME,
		   RCM.ASSETS_TYPE,
		   RCM.APPLY_COUNT_DEMAND,
		   RCM.GOODS_COUNT_DEMAND,
		   RCM.BRAND,
		   RCM.FUNCTIONS)
		VALUES
		  (
		   #{id},
		   #{receiveGoodsId},
		   #{demandId},
		   #{demandDetailId},
		   #{purchaseId},
		   #{purchaseDetailId},
		   #{applyDetailId},
		   #{assetsName},
		   #{assetsType},
		   #{applyCountDemand},
		   #{thisGoodsCountDemand},
		   #{brand},
		   #{functions}
		   )
	</insert>

	<insert id="saveDeleteBranch">
		INSERT INTO TB_FA_RECEIVE_MAPPING_BK RCM
		(RCM.ID,
		RCM.RECEIVE_GOODS_ID,
		RCM.DEMAND_ID,
		RCM.DEMAND_DETAIL_ID,
		RCM.PURCHASE_ID,
		RCM.PURCHASE_DETAIL_ID,
		RCM.APPLY_DETAIL_ID,
		RCM.ASSETS_NAME,
		RCM.ASSETS_TYPE,
		RCM.APPLY_COUNT_DEMAND,
		RCM.GOODS_COUNT_DEMAND,
		RCM.BRAND,
		RCM.FUNCTIONS)
		<foreach item="item" index="index" collection="list" separator="union all">
			(
			SELECT
			#{item.id},
			#{item.receiveGoodsId},
			#{item.demandId},
			#{item.demandDetailId},
			#{item.purchaseId},
			#{item.purchaseDetailId},
			#{item.applyDetailId},
			#{item.assetsName},
			#{item.assetsType},
			#{item.applyCountDemand},
			#{item.thisGoodsCountDemand},
			#{item.brand},
			#{item.functions}
			FROM DUAL
			)
		</foreach>
	</insert>
	
	<!-- (收货单 修改)  回写TB_FA_RECEIVE_CHECK_MAPPING  -->
	<update id="updateReceiveGoodsMapping">
	UPDATE TB_FA_RECEIVE_CHECK_MAPPING RCM
		   SET 
		       RCM.GOODS_COUNT_DEMAND = #{goodsCountDemand}
		 where 1 = 1
		   and RCM.RECEIVE_GOODS_ID = #{receiveGoodsId}
		   and RCM.APPLY_DETAIL_ID = #{applyDetailId}
		   and RCM.DEMAND_ID = #{demandId}
		   and RCM.DEMAND_DETAIL_ID = #{demandDetailId}
		   and RCM.PURCHASE_ID = #{purchaseId}
	</update>
	<delete id="deleteReceiveCheck">
		delete from TB_FA_RECEIVE_CHECK_MAPPING where RECEIVE_GOODS_ID=#{receiveGoodsId}
	</delete>
	<select id="searchReceiveGoodsMappingList" resultMap="receiveGoodsMappingResultMap">
 		select * from TB_FA_RECEIVE_CHECK_MAPPING t where t.receive_goods_id=#{receiveGoodsId}
	</select>

	<select id="searchPurchaseCommonByPurchaseId" resultMap="receiveGoodsMappingResultMap">

		 SELECT t.PURCHASE_ID,
		       t.PURCHASE_DETAIL_ID,
	           t.SAP_MAIN_ASSET_CODE,
    	      t.SAP_SEC_ASSET_CODE,
		       t.SAP_ASSETS_CODE --sap编码
		  FROM TB_FA_PURCHASE_COMMON t
		 WHERE 1 = 1
		   AND t.PURCHASE_ID = #{purchaseId }
		ORDER BY t.PURCHASE_ID,t.PURCHASE_DETAIL_ID,t.sap_assets_code
	</select>
 </mapper>

