<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.opple.fa.purchase.dao.PaymentTermDAO">
    <!-- oracle 分页头 -->
    <sql id="pagination_Head">
        <![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
    </sql>
    <!-- oracle 分页尾 -->
    <sql id="pagination_Tail">
        <![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
    </sql>
    <!-- count * from -->
    <sql id="count_Start_Head">
        <![CDATA[select count(*) from ( ]]>
    </sql>
    <sql id="count_Start_Tail">
        <![CDATA[) countObj ]]>
    </sql>
    <resultMap id="paymentMap" type="com.opple.fa.purchase.entity.PaymentTerm">
        <result property="id" column="ID" />
        <result property="purchaseId" column="PURCHASE_ID" />
        <result property="nper" column="NPER" />
        <result property="paymentType" column="PAYMENT_TYPE" />
        <result property="paymentRatio" column="PAYMENT_RATIO" />
        <result property="paymentRemarks" column="PAYMENT_REMARKS" />
        <result property="createBy" column="CREATE_BY" />
        <result property="createDate" column="CREATE_DATE" />
        <result property="updateBy" column="UPDATE_BY" />
        <result property="updateDate" column="UPDATE_DATE" />
    </resultMap>
    <select id="save">
        insert into TB_FA_PAYMENT_TERM 
          ( ID,
        	PURCHASE_ID,
        	NPER,
        	PAYMENT_TYPE,
        	PAYMENT_RATIO,
        	PAYMENT_REMARKS,
        	CREATE_BY,
        	CREATE_DATE,
        	UPDATE_BY,
        	UPDATE_DATE
        	)   
         values
          ( seq_purchase_apply_mapping.nextval,  
            #{purchaseId},   
            #{nper},   
            #{paymentType},   
            #{paymentRatio},   
            #{paymentRemarks}, 
            #{createBy},   
            #{createDate},   
            #{updateBy},     
            #{updateDate})
    </select>

    <insert id="saveDeleteBranch">
        insert into TB_FA_PAYMENT_TERM_BK
          ( ID,
        	PURCHASE_ID,
        	NPER,
        	PAYMENT_TYPE,
        	PAYMENT_RATIO,
        	PAYMENT_REMARKS,
        	CREATE_BY,
        	CREATE_DATE,
        	UPDATE_BY,
        	UPDATE_DATE
        	)
        VALUES
            ( #{id},
            #{purchaseId},
            #{nper},
            #{paymentType},
            #{paymentRatio},
            #{paymentRemarks},
            #{createBy},
            #{createDate},
            #{updateBy},
            sysdate)
    </insert>




   <select id="searchPaymentTermByOrderId" resultMap="paymentMap">
		SELECT *
		FROM BCC.TB_FA_PAYMENT_TERM 
		WHERE 1=1 
		<if
			test="cdocument != null and cdocument != ''">
			AND PURCHASE_ID LIKE '%' || #{cdocument} || '%' 
		</if>
		ORDER BY NPER
	</select>

    <select id="searchPaymentTermByOrderId1" resultMap="paymentMap">
        SELECT *
        FROM BCC.TB_FA_PAYMENT_TERM
        WHERE PURCHASE_ID = #{cdocument}
        ORDER BY NPER
    </select>
	<delete id="deletePaymentTermByPurchaseId">
		DELETE FROM TB_FA_PAYMENT_TERM WHERE PURCHASE_ID = #{cdocument}  	
	</delete>
	<select id="searchMaxTermByOrderId" resultMap="paymentMap">
		select max(NPER) NPER  from tb_fa_payment_term q where q.purchase_id = #{cdocument}	
	</select>
	<select id="searchPaymentRatioByOrderId" resultMap="paymentMap">
		SELECT T.NPER,T.PAYMENT_TYPE, T.PAYMENT_RATIO
		  FROM TB_FA_PAYMENT_TERM T
		 WHERE T.PURCHASE_ID = #{purchaseId}
		   AND T.NPER = #{nper}
		UNION ALL
		SELECT -1 NPER,'' PAYMENT_TYPE, NVL(SUM(T.PAYMENT_RATIO), 0) PAYMENT_RATIO
		  FROM TB_FA_PAYMENT_TERM T
		 WHERE T.PURCHASE_ID = #{purchaseId}
		   AND T.NPER <![CDATA[ < ]]> #{nper}
	</select>
</mapper>