<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.opple.fa.purchase.dao.ApplyDemandMappingDAO">
    <!-- oracle 分页头 -->
    <sql id="pagination_Head">
        <![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
    </sql>
    <!-- oracle 分页尾 -->
    <sql id="pagination_Tail">
        <![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
    </sql>
    <!-- count * from -->
    <sql id="count_Start_Head">
        <![CDATA[select count(*) from ( ]]>
    </sql>
    <sql id="count_Start_Tail">
        <![CDATA[) countObj ]]>
    </sql>
    <resultMap id="applyDemandMappingMap" type="com.opple.fa.purchase.entity.ApplyDemandMapping">
        <result property="id" column="ID" />
        <result property="mergeNumber" column="MERGE_NUMBER" />
        <result property="assetsName" column="ASSETS_NAME" />
        <result property="demandDetailId" column="DEMAND_DETAIL_ID" />
        <result property="applyId" column="APPLY_ID" />
        <result property="demandCount" column="DEMAND_COUNT" />
        <result property="applyCount" column="APPLY_COUNT" />
        <result property="notApplyCount" column="NOT_APPLY_COUNT" />
        <result property="createBy" column="CREATE_BY" />
        <result property="createDate" column="CREATE_DATE" />
        <result property="updateBy" column="UPDATE_BY" />
        <result property="updateDate" column="UPDATE_DATE" />
    </resultMap>
    <resultMap id="assetsDetailMap" type="com.opple.fa.purchase.model.ApplyDemandMappingModel">
        <result property="id" column="ID" />
        <result property="mergeNumber" column="MERGE_NUMBER" />
        <result property="assetsName" column="ASSETS_NAME" />
        <result property="applyId" column="APPLY_ID" />
        <result property="demandCount" column="DEMAND_COUNT" />
        <result property="applyCount" column="APPLY_COUNT" />
        <result property="notApplyCount" column="NOT_APPLY_COUNT" />
        
        <result property="specificationParameter" column="SPECIFICATION_PARAMETER" />
        <result property="functions" column="FUNCTIONS" />
        <result property="acceptanceCriteria" column="ACCEPTANCE_CRITERIA" />
        <result property="optionalAccessories" column="OPTIONAL_ACCESSORIES" />
        <result property="units" column="UNITS" />
        <result property="inquiryUnitPrice" column="INQUIRY_UNIT_PRICE" />
        <result property="requirementsDate" column="REQUIREMENTS_DATE" />
        
        <result property="demandOrderId" column="DEMAND_ORDER_ID" />
        <result property="demandDetailId" column="DEMAND_DETAIL_ID" />
        <result property="costCenter" column="COST_CENTER" />
        <result property="costCenterCode" column="COST_CENTER_CODE" />
        <result property="useDescription" column="USE_DESCRIPTION" />
        <result property="applyUser" column="APPLY_USER" />
        <result property="applyUserCode" column="APPLY_USER_CODE" />
        <result property="applyDepartment" column="APPLY_DEPARTMENT" />
        <result property="applyDepartmentCode" column="APPLY_DEPARTMENT_CODE" />
        <result property="projectCode" column="PROJECT_CODE" />
        <result property="budgetYear" column="BUDGET_YEAR" />
    </resultMap>

    <insert id="save">
        insert into TB_FA_APPLY_DEMAND_MAPPING 
          ( ID,
        	MERGE_NUMBER,
            ASSETS_NAME,
            DEMAND_DETAIL_ID,
            APPLY_ID,
	        DEMAND_COUNT,
	        APPLY_COUNT,
	        NOT_APPLY_COUNT,
            CREATE_BY,
            CREATE_DATE,
            UPDATE_BY,
            UPDATE_DATE)   
         values
          ( seq_apply_demand_mapping.nextval,  
            #{mergeNumber}, 
            #{assetsName},   
            #{demandDetailId},   
            #{applyId},   
            #{demandCount},   
            #{applyCount},   
            #{notApplyCount}, 
            #{createBy},   
            #{createDate},   
            #{updateBy},   
            #{updateDate})
    </insert>

    <insert id="saveDeleteBatch" >
        insert into TB_FA_APPLY_DEMAND_MAPPING_BK
        ( ID,
        MERGE_NUMBER,
        ASSETS_NAME,
        DEMAND_DETAIL_ID,
        APPLY_ID,
        DEMAND_COUNT,
        APPLY_COUNT,
        NOT_APPLY_COUNT,
        CREATE_BY,
        CREATE_DATE,
        UPDATE_BY,
        UPDATE_DATE)
        VALUES
            ( #{id},
            #{mergeNumber},
            #{assetsName},
            #{demandDetailId},
            #{applyId},
            #{demandCount},
            #{applyCount},
            #{notApplyCount},
            #{createBy},
            #{createDate},
            #{updateBy},
            sysdate)
    </insert>
    <!-- 采购申请查询资产明细 -->
    <select id="searchAssetsDetail" resultMap="assetsDetailMap">
    	SELECT TM.ID,
	       TM.MERGE_NUMBER,
	       TM.DEMAND_DETAIL_ID,
	       TM.ASSETS_NAME,
	       TM.DEMAND_COUNT,
	       T.SPECIFICATION_PARAMETER,
	       T.FUNCTIONS,
	       T.ACCEPTANCE_CRITERIA,
	       T.OPTIONAL_ACCESSORIES,
	       T.UNITS,
	       T.INQUIRY_UNIT_PRICE,
	       T.REQUIREMENTS_DATE,
	       T.COST_CENTER,
	       T.COST_CENTER_CODE,
	       T.USE_DESCRIPTION,
	       T.DEMAND_ORDER_ID
	  	FROM TB_FA_APPLY_DEMAND_MAPPING TM, TB_FA_DEMAND_ORDER_DETAIL T
	 	WHERE TM.APPLY_ID = #{applyId}
	   	AND TM.DEMAND_DETAIL_ID = T.ID
    </select>
    <!-- 采购订单选择明细 -->
    <select id="searchForPurchaseOrder" resultMap="assetsDetailMap">
    	SELECT TM.ID,
	       TM.MERGE_NUMBER,
	       TM.DEMAND_DETAIL_ID,
	       T.DEMAND_ORDER_ID,
	       TM.APPLY_ID,
	       TM.ASSETS_NAME,
	       TM.DEMAND_COUNT,
	       TM.NOT_APPLY_COUNT,
	       T.APPLY_USER,
	       T.APPLY_USER_CODE,
	       T.APPLY_DEPARTMENT,
	       T.APPLY_DEPARTMENT_CODE,
	       T.SPECIFICATION_PARAMETER,
	       T.FUNCTIONS,
	       T.ACCEPTANCE_CRITERIA,
	       T.OPTIONAL_ACCESSORIES,
	       T.UNITS,
	       T.INQUIRY_UNIT_PRICE,
	       T.REQUIREMENTS_DATE,
	       T.COST_CENTER,
	       T.COST_CENTER_CODE,
	       T.USE_DESCRIPTION,
	       T.PROJECT_CODE,
	       T.BUDGET_YEAR
	  	FROM TB_FA_APPLY_DEMAND_MAPPING TM, TB_FA_DEMAND_ORDER_DETAIL T
	 	WHERE TM.APPLY_ID = #{applyOrderId}  
	   	AND TM.DEMAND_DETAIL_ID = T.ID
	   	AND TM.MERGE_NUMBER = #{mergeNumber}
    </select>
    	<select id="deleteApplyDemandMappingByApplyId">
		DELETE FROM TB_FA_APPLY_DEMAND_MAPPING WHERE APPLY_ID = #{applyId}  	
	</select>
	<update id="writeBack">
		UPDATE TB_FA_APPLY_DEMAND_MAPPING 	
		  SET APPLY_COUNT = APPLY_COUNT+#{applyCount},  	
		  NOT_APPLY_COUNT = NOT_APPLY_COUNT-#{applyCount}  	
		  WHERE ID = #{applyDemandId}  	
	</update>
	<select id="searchApplyDemandMappingById" resultMap="applyDemandMappingMap">
		SELECT T.* FROM TB_FA_APPLY_DEMAND_MAPPING T WHERE T.ID = #{id}
	</select>
    <select id="searchApplyDemandMappingByApplyId" resultMap="applyDemandMappingMap">

        SELECT T.* FROM TB_FA_APPLY_DEMAND_MAPPING T WHERE T.APPLY_ID = #{applyId}
    </select>

    <resultMap id="demandApplyBudgetMap" type="com.opple.fa.purchase.entity.DemandApplyBudget">
        <result property="applyId" column="apply_Id" />
        <result property="budgetYear" column="budget_year" />
        <result property="demandCount" column="demand_Count" />
        <result property="applyCount" column="apply_count" />
        <result property="projectCode" column="project_Code" />
        <result property="demandPrice" column="demand_Price" />
        <result property="applyPrice" column="apply_Price" />
    </resultMap>
    <select id="searchDemandApplyBudget" resultMap="demandApplyBudgetMap">
        select t.apply_id,
                t1.budget_year,
               t.demand_count,
               t.apply_count,
               t1.project_code,
               t1.inquiry_unit_price demand_price,
               t2.inquiry_unit_price apply_price
          from tb_fa_apply_demand_mapping t
          left join tb_fa_demand_order_detail t1
            on t1.id = t.demand_detail_id
          left join tb_fa_apply_order_detail t2
            on t.merge_number = t2.merge_number
           and t.apply_id = t2.apply_order_id
          where t.apply_id = #{applyId}

    </select>
</mapper>