<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.opple.fa.purchase.dao.CheckAcceptanceDetailDAO">
	<!-- oracle 分页头 -->
	<sql id="pagination_Head">
		<![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
	</sql>
	<!-- oracle 分页尾 -->
	<sql id="pagination_Tail">
		<![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
	</sql>
	<!-- count * from -->
	<sql id="count_Start_Head">
		<![CDATA[select count(*) from ( ]]>
	</sql>
	<sql id="count_Start_Tail">
		<![CDATA[) countObj ]]>
	</sql>

	<resultMap id="checkAcceptanceDetailMap"
		type="com.opple.fa.purchase.entity.CheckAcceptanceDetail">
		<result property="id" column="ID" />
		<result property="checkAcceptDetailId" column="CHECK_ACCEPT_DETAIL_ID" />
		<result property="checkAcceptId" column="CHECK_ACCEPT_ID" />
		<result property="receiveGoodsId" column="RECEIVE_GOODS_ID"/>
		<result property="receiveGoodsDetailId" column="RECEIVE_GOODS_DETAIL_ID"/>
		<result property="purchaseId" column="PURCHASE_ID"/>
		<result property="purchaseDetailId" column="PURCHASE_DETAIL_ID"/>
		<result property="applyDetailId" column="APPLY_DETAIL_ID"/>
		<result property="demandId" column="DEMAND_ID"/>
		<result property="demandDetailId" column="DEMAND_DETAIL_ID"/>
		<result property="assetsName" column="ASSETS_NAME"/>
		<result property="mmAssetsCode" column="MM_ASSETS_CODE"/><!-- 固定资产(字段编码)MM+sap主编码+sap次级编码  -->
		<result property="sapAssetsCode" column="SAP_ASSETS_CODE"/><!-- sap次编码-->
		<result property="manageapplyDepartmentCode" column="MANAGE_APPLY_DEPARTMENT_CODE" /><!-- 归口管理部门编码(手填)-->
		<result property="serialNumber" column="SERIAL_NUMBER"/><!-- 序列号(手填) -->
		<result property="pasteAssetsTag" column="PASTE_ASSETS_TAG"/><!-- 是否有粘贴资产标签(手填) -->
		<result property="assetsPhoto" column="ASSETS_PHOTO"/><!-- 资产照片(手填) -->
		<result property="otherCalibrationReport" column="OTHER_CALIBRATION_REPORT"/><!-- 是否有第三方校验报告(手填) -->
		<!-- 资产原值=单价（含税） --><!-- 单价从收货里取 -->
		<!-- 资产原值*净残值率 = 净残值 -->
	    <!-- 资产原值 - 净残值 = 资产净值 -->
		<result property="createBy" column="CREATE_BY" />
		<result property="createDate" column="CREATE_DATE" />
		<result property="updateBy" column="UPDATE_BY" />
		<result property="updateDate" column="UPDATE_DATE" />
		<!--资产卡片表中的主键 -->
		<result property="cardId" column="card_id" />
		<result property="recWarrantyPeriod" column="REC_WARRANTY_PERIOD" />
		<result property="storageLocation" column="STORAGE_LOCATION" />
		<result property="epMaterialdocu" column="EP_MATERIALDOCUMENT" />
		<result property="epBelnr" column="E_BELNR" />
		<result property="epMatdocumentyear" column="EP_MATDOCUMENTYEAR" />
		<result property="isSap" column="ISSAP" />
		<result property="systeManagementCode" column="SYSTE_MANAGEMENT_CODE" />
	</resultMap>
	
	<!-- 保存验收 行 -->
	<insert id="saveCheckAcceptanceDetail" keyProperty="id" useGeneratedKeys="true">
		<selectKey keyProperty="id" order="BEFORE" resultType="long">
			SELECT SEQ_FA_CHECK_ACCEPTANCE_DETAIL.NEXTVAL FROM DUAL		
		</selectKey>					
		INSERT INTO TB_FA_CHECK_ACCEPTANCE_DETAIL CAD
		(
		CAD.REC_WARRANTY_PERIOD,
		CAD.STORAGE_LOCATION,
		 CAD.CARD_ID,
		 CAD.ID,
         CAD.CHECK_ACCEPT_ID,
         CAD.RECEIVE_GOODS_ID,
         CAD.RECEIVE_GOODS_DETAIL_ID,
         CAD.PURCHASE_ID,
         CAD.PURCHASE_DETAIL_ID,
         CAD.APPLY_DETAIL_ID,
         CAD.DEMAND_ID,
         CAD.DEMAND_DETAIL_ID,
         CAD.ASSETS_NAME,
         CAD.SAP_ASSETS_CODE,
         CAD.MM_ASSETS_CODE,
        CAD.SYSTE_MANAGEMENT_CODE,
         CAD.ASSETS_PHOTO,
         CAD.MANAGE_APPLY_DEPARTMENT_CODE,
         CAD.OTHER_CALIBRATION_REPORT,
         CAD.PASTE_ASSETS_TAG,
         CAD.SERIAL_NUMBER,
		 CAD.ASSETS_TYPE
		 )
		VALUES
		(
		#{recWarrantyPeriod},
		#{storageLocation},
		#{cardId},
		#{id},
		   #{checkAcceptId},
		   #{receiveGoodsId},
		   #{receiveGoodsDetailId},
		   #{purchaseId},
		   #{purchaseDetailId},
		   #{applyDetailId},
		   #{demandId},
		   #{demandDetailId},
		   #{assetsName},
		   #{sapAssetsCode},
		   #{mmAssetsCode},
           #{systeManagementCode},
		   #{assetsPhoto},
		   #{manageapplyDepartmentCode},
		   #{otherCalibrationReport},
		   #{pasteAssetsTag},
		   #{serialNumber},
		   #{assetsType}
		)

	</insert>

	<insert id="saveDeleteBranch">
		INSERT INTO TB_FA_CHECK_DETAIL_BK CAD
		(
		CAD.REC_WARRANTY_PERIOD,
		CAD.STORAGE_LOCATION,
		CAD.CARD_ID,
		CAD.ID,
		CAD.CHECK_ACCEPT_ID,
		CAD.RECEIVE_GOODS_ID,
		CAD.RECEIVE_GOODS_DETAIL_ID,
		CAD.PURCHASE_ID,
		CAD.PURCHASE_DETAIL_ID,
		CAD.APPLY_DETAIL_ID,
		CAD.DEMAND_ID,
		CAD.DEMAND_DETAIL_ID,
		CAD.ASSETS_NAME,
		CAD.SAP_ASSETS_CODE,
		CAD.MM_ASSETS_CODE,
		CAD.SYSTE_MANAGEMENT_CODE,
		CAD.ASSETS_PHOTO,
		CAD.MANAGE_APPLY_DEPARTMENT_CODE,
		CAD.OTHER_CALIBRATION_REPORT,
		CAD.PASTE_ASSETS_TAG,
		CAD.SERIAL_NUMBER,
		CAD.ASSETS_TYPE
		)
		<foreach item="item" index="index" collection="list" separator="union all">
			(
			SELECT
			#{item.recWarrantyPeriod},
			#{item.storageLocation},
			#{item.cardId},
			#{item.checkAcceptDetailId},
			#{item.checkAcceptId},
			#{item.receiveGoodsId},
			#{item.receiveGoodsDetailId},
			#{item.purchaseId},
			#{item.purchaseDetailId},
			#{item.applyDetailId},
			#{item.demandId},
			#{item.demandDetailId},
			#{item.assetsName},
			#{item.sapAssetsCode},
			#{item.mmAssetsCode},
			#{item.systeManagementCode},
			#{item.assetsPhoto},
			#{item.manageapplyDepartmentCode},
			#{item.otherCalibrationReport},
			#{item.pasteAssetsTag},
			#{item.serialNumber},
			#{item.assetsType}
			FROM DUAL
			)
		</foreach>
	</insert>


    <!-- 修改后保存验收 行 -->
    <update id="updateCheckAcceptanceDetailById" >

        update TB_FA_CHECK_ACCEPTANCE_DETAIL CAD
        set
        CAD.REC_WARRANTY_PERIOD= #{recWarrantyPeriod},
        CAD.STORAGE_LOCATION =#{storageLocation},
        CAD.CARD_ID=#{cardId},
        CAD.CHECK_ACCEPT_ID=#{checkAcceptId},
        CAD.RECEIVE_GOODS_ID=#{receiveGoodsId},
        CAD.RECEIVE_GOODS_DETAIL_ID=#{receiveGoodsDetailId},
        CAD.PURCHASE_ID= #{purchaseId},
        CAD.PURCHASE_DETAIL_ID=#{purchaseDetailId},
        CAD.APPLY_DETAIL_ID=#{applyDetailId},
        CAD.DEMAND_ID=#{demandId},
        CAD.DEMAND_DETAIL_ID=#{demandDetailId},
        CAD.ASSETS_NAME=#{assetsName},
        CAD.SAP_ASSETS_CODE=#{sapAssetsCode},
        CAD.MM_ASSETS_CODE=#{mmAssetsCode},
        CAD.SYSTE_MANAGEMENT_CODE=#{systeManagementCode},
        CAD.ASSETS_PHOTO=#{assetsPhoto},
        CAD.MANAGE_APPLY_DEPARTMENT_CODE=#{manageapplyDepartmentCode},
        CAD.OTHER_CALIBRATION_REPORT=#{otherCalibrationReport},
        CAD.PASTE_ASSETS_TAG=#{pasteAssetsTag},
        CAD.SERIAL_NUMBER=#{serialNumber},
        CAD.ASSETS_TYPE=#{assetsType}
        where CAD.ID =  #{checkAcceptDetailId}

    </update>


	<select id="getCheckAcceptanceDetailByDocument" parameterType="string" resultMap="checkAcceptanceDetailMap">
		 SELECT CAD.ID CHECK_ACCEPT_DETAIL_ID,
		        CAD.CHECK_ACCEPT_ID,
		        CAD.RECEIVE_GOODS_ID,
		        CAD.RECEIVE_GOODS_DETAIL_ID,
		        CAD.PURCHASE_ID,
		        CAD.PURCHASE_DETAIL_ID,
		        CAD.APPLY_DETAIL_ID,
		        CAD.DEMAND_ID,
		        CAD.DEMAND_DETAIL_ID,
		        CAD.ASSETS_NAME,
		        CAD.SAP_ASSETS_CODE,
		        CAD.MM_ASSETS_CODE,
		        CAD.SYSTE_MANAGEMENT_CODE,
		        CAD.ASSETS_PHOTO,
		        CAD.MANAGE_APPLY_DEPARTMENT_CODE,
		        CAD.OTHER_CALIBRATION_REPORT,
		        CAD.PASTE_ASSETS_TAG,
		        CAD.SERIAL_NUMBER,
		        CAD.REC_WARRANTY_PERIOD,
		        CAD.STORAGE_LOCATION,
		        CAD.CARD_ID,
		        CAD.EP_MATERIALDOCUMENT,
				   CAD.E_BELNR,
				   CAD.EP_MATDOCUMENTYEAR,
				   CAD.ISSAP
		   FROM TB_FA_CHECK_ACCEPTANCE_DETAIL CAD
		   WHERE 1=1
		   AND CAD.CHECK_ACCEPT_ID = #{checkAccpetId}
	</select>
	<!-- (修改 先删除)根据验收单号 -->
	<delete id="delCheckAcceptanceByCheckAcceptId">
	DELETE TB_FA_CHECK_ACCEPTANCE_DETAIL CAD
	 WHERE 1 = 1
	   AND CAD.CHECK_ACCEPT_ID = #{checkAcceptId}
	</delete>

	<update id="updateCheckAcceptanceDetailSapById">
		update TB_FA_CHECK_ACCEPTANCE_DETAIL CA
		set
		CA.ISSAP=#{isSap},
	   CA.EP_MATERIALDOCUMENT = #{epMaterialdocu},
	   CA.E_BELNR = #{epBelnr },
	   CA.EP_MATDOCUMENTYEAR = #{epMatdocumentyear}
	 WHERE 1 = 1
	   AND CA.ID = #{id}

	</update>
	<select id="getCheckAcceptanceDetailById" parameterType="long" resultMap="checkAcceptanceDetailMap">
		select * from TB_FA_CHECK_ACCEPTANCE_DETAIL
		where ID=#{id}
	</select>
	<update id="updateAssetsBudget">
		update tb_fa_assets_budget
		SET
		CHECK_MONEY = nvl(CHECK_MONEY,0) + #{checkMoney}
		where budget_year = #{budgetYear}
		and project_code=#{projectCode}
	</update>
</mapper>