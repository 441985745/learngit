<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.opple.fa.purchase.dao.ApplyOrderDetailDAO">
    <!-- oracle 分页头 -->
    <sql id="pagination_Head">
        <![CDATA[select * from ( select row_.*, rownum rownum_ from ( ]]>
    </sql>
    <!-- oracle 分页尾 -->
    <sql id="pagination_Tail">
        <![CDATA[) row_ where rownum <= #{pager.pageSize}* #{pager.offset} ) where rownum_ >= #{pager.firstResult} + 1]]>
    </sql>
    <!-- count * from -->
    <sql id="count_Start_Head">
        <![CDATA[select count(*) from ( ]]>
    </sql>
    <sql id="count_Start_Tail">
        <![CDATA[) countObj ]]>
    </sql>
    <resultMap id="applyOrderDetailMap" type="com.opple.fa.purchase.entity.ApplyOrderDetail">
        <result property="id" column="ID" />
        <result property="applyOrderId" column="APPLY_ORDER_ID" />
        <result property="mergeNumber" column="MERGE_NUMBER" />
        <result property="applyUser" column="APPLY_USER" />
        <result property="assetsName" column="ASSETS_NAME" />
        <result property="demandCount" column="DEMAND_COUNT" />
        <result property="applyCount" column="APPLY_COUNT" />
        <result property="notApplyCount" column="NOT_APPLY_COUNT" />
        <result property="createBy" column="CREATE_BY" />
        <result property="createDate" column="CREATE_DATE" />
        <result property="updateBy" column="UPDATE_BY" />
        <result property="updateDate" column="UPDATE_DATE" />
        <result property="createByCode" column="CREATE_BY_CODE" />
        <result property="updateByCode" column="UPDATE_BY_CODE" />
        <result property="specificationParameter" column="SPECIFICATION_PARAMETER" />
        <result property="functions" column="FUNCTIONS" />
        <result property="acceptanceCriteria" column="ACCEPTANCE_CRITERIA" />
        <result property="optionalAccessories" column="OPTIONAL_ACCESSORIES" />
        <result property="units" column="UNITS" />
        <result property="inquiryUnitPrice" column="INQUIRY_UNIT_PRICE" />
        <result property="inquiryPrice" column="INQUIRY_PRICE" />
        <result property="requirementsDate" column="REQUIREMENTS_DATE" />
        <result property="purchaseUnitPrice" column="PURCHASE_UNIT_PRICE" />
        <result property="purchasePrice" column="PURCHASE_PRICE" />
        <result property="procurementReturnPeriod" column="PROCUREMENT_RETURN_PERIOD" />
        <result property="assetClassification" column="ASSET_CLASSIFICATION" />
        <result property="depreciation" column="DEPRECIATION" />
        <result property="codingMode" column="CODING_MODE" />
        <result property="mainAssetCode" column="MAIN_ASSET_CODE" />
        <result property="secondary" column="SECONDARY" />
        <result property="ledgerAccount" column="LEDGER_ACCOUNT" />
        <result property="costCenter" column="COST_CENTER" />
        <result property="applyUserCode" column="APPLY_USER_CODE" />
        <result property="costCenterCode" column="COST_CENTER_CODE" />
        <result property="nextSecondaryCoding" column="NEXT_SECONDARYCODING" />
        <result property="purchaseAvaMoney" column="PURCHASE_AVA_MONEY" />
    </resultMap>

    
    <select id="searchApplyOrderDetailByOrderId" resultMap="applyOrderDetailMap">
        SELECT ID,
        APPLY_ORDER_ID,
        MERGE_NUMBER,
        APPLY_USER,
        ASSETS_NAME,
        DEMAND_COUNT,
        APPLY_COUNT,
        NOT_APPLY_COUNT,
        CREATE_BY,
        CREATE_DATE,
        UPDATE_BY,
        UPDATE_DATE,
        CREATE_BY_CODE,
        UPDATE_BY_CODE,
        SPECIFICATION_PARAMETER,
        FUNCTIONS,
        ACCEPTANCE_CRITERIA,
        OPTIONAL_ACCESSORIES,
        UNITS,
        INQUIRY_UNIT_PRICE,
        INQUIRY_PRICE,
       	REQUIREMENTS_DATE,
        PURCHASE_UNIT_PRICE,
        PURCHASE_PRICE,
        PROCUREMENT_RETURN_PERIOD,
        ASSET_CLASSIFICATION,
        DEPRECIATION,
        CODING_MODE,
        MAIN_ASSET_CODE,
        SECONDARY,
        LEDGER_ACCOUNT,
        COST_CENTER,
        COST_CENTER_CODE,
        APPLY_USER_CODE
        FROM TB_FA_APPLY_ORDER_DETAIL
        WHERE 1=1
        <if
            test="applyOrder.cdocument != null and applyOrder.cdocument != ''">
            AND APPLY_ORDER_ID = #{applyOrder.cdocument}
        </if>
    </select>

    <insert id="save">
     INSERT INTO TB_FA_APPLY_ORDER_DETAIL 
       ( ID,
        APPLY_ORDER_ID,
        MERGE_NUMBER,
        APPLY_USER,
        ASSETS_NAME,
        DEMAND_COUNT,
        APPLY_COUNT,
        NOT_APPLY_COUNT,
        CREATE_BY,
        CREATE_DATE,
        UPDATE_BY,
        UPDATE_DATE,
        CREATE_BY_CODE,
        UPDATE_BY_CODE,
        SPECIFICATION_PARAMETER,
        FUNCTIONS,
        ACCEPTANCE_CRITERIA,
        OPTIONAL_ACCESSORIES,
        UNITS,
        INQUIRY_UNIT_PRICE,
        INQUIRY_PRICE,
       	REQUIREMENTS_DATE,
        PURCHASE_UNIT_PRICE,
        PURCHASE_PRICE,
        PROCUREMENT_RETURN_PERIOD,
        ASSET_CLASSIFICATION,
        DEPRECIATION,
        CODING_MODE,
        MAIN_ASSET_CODE,
        SECONDARY,
        LEDGER_ACCOUNT,
        COST_CENTER,
        COST_CENTER_CODE,
        APPLY_USER_CODE
        )   
         VALUES
          ( seq_apply_order_detail.nextval,  
            #{applyOrderId},   
            #{mergeNumber}, 
            #{applyUser},   
            #{assetsName},   
            #{demandCount},   
            #{applyCount},   
            #{notApplyCount}, 
            #{createBy},   
            #{createDate},   
            #{updateBy}, 
            #{updateDate}, 
            #{createByCode}, 
            #{updateByCode}, 
            #{specificationParameter}, 
            #{functions}, 
            #{acceptanceCriteria}, 
            #{optionalAccessories}, 
            #{units}, 
            #{inquiryUnitPrice}, 
            #{inquiryPrice}, 
            #{requirementsDate}, 
            #{inquiryUnitPrice}, 
            #{inquiryPrice}, 
            #{requirementsDate}, 
            #{assetClassification}, 
            #{depreciation}, 
            #{codingMode}, 
            #{mainAssetCode}, 
            #{secondary}, 
            #{ledgerAccount},   
            #{costCenter},   
            #{costCenterCode},   
            #{applyUserCode}
            )
    </insert>

    <insert id="saveDeleteBatch" >
        INSERT INTO TB_FA_APPLY_ORDER_DETAIL_BK
        ( ID,
        APPLY_ORDER_ID,
        MERGE_NUMBER,
        APPLY_USER,
        ASSETS_NAME,
        DEMAND_COUNT,
        APPLY_COUNT,
        NOT_APPLY_COUNT,
        CREATE_BY,
        CREATE_DATE,
        UPDATE_BY,
        UPDATE_DATE,
        CREATE_BY_CODE,
        UPDATE_BY_CODE,
        SPECIFICATION_PARAMETER,
        FUNCTIONS,
        ACCEPTANCE_CRITERIA,
        OPTIONAL_ACCESSORIES,
        UNITS,
        INQUIRY_UNIT_PRICE,
        INQUIRY_PRICE,
        REQUIREMENTS_DATE,
        PURCHASE_UNIT_PRICE,
        PURCHASE_PRICE,
        PROCUREMENT_RETURN_PERIOD,
        ASSET_CLASSIFICATION,
        DEPRECIATION,
        CODING_MODE,
        MAIN_ASSET_CODE,
        SECONDARY,
        LEDGER_ACCOUNT,
        COST_CENTER,
        COST_CENTER_CODE,
        APPLY_USER_CODE
        )
        VALUES
            ( #{id},
            #{applyOrderId},
            #{mergeNumber},
            #{applyUser},
            #{assetsName},
            #{demandCount},
            #{applyCount},
            #{notApplyCount},
            #{createBy},
            #{createDate},
            #{updateBy},
            sysdate,
            #{createByCode},
            #{updateByCode},
            #{specificationParameter},
            #{functions},
            #{acceptanceCriteria},
            #{optionalAccessories},
            #{units},
            #{inquiryUnitPrice},
            #{inquiryPrice},
            #{requirementsDate},
            #{inquiryUnitPrice},
            #{inquiryPrice},
            #{requirementsDate},
            #{assetClassification},
            #{depreciation},
            #{codingMode},
            #{mainAssetCode},
            #{secondary},
            #{ledgerAccount},
            #{costCenter},
            #{costCenterCode},
            #{applyUserCode}
            )
    </insert>


	<delete id="deleteOrderDetailByApplyId">
		DELETE FROM TB_FA_APPLY_ORDER_DETAIL WHERE APPLY_ORDER_ID = #{applyOrderId}  	
	</delete>
		
		<select id="get" resultMap="applyOrderDetailMap">
		SELECT ID,
        APPLY_ORDER_ID,
        MERGE_NUMBER,
        APPLY_USER,
        ASSETS_NAME,
        DEMAND_COUNT,
        APPLY_COUNT,
        NOT_APPLY_COUNT,
        CREATE_BY,
        CREATE_DATE,
        UPDATE_BY,
        UPDATE_DATE,
        CREATE_BY_CODE,
        UPDATE_BY_CODE,
        SPECIFICATION_PARAMETER,
        FUNCTIONS,
        ACCEPTANCE_CRITERIA,
        OPTIONAL_ACCESSORIES,
        UNITS,
        INQUIRY_UNIT_PRICE,
        INQUIRY_PRICE,
       	REQUIREMENTS_DATE,
        PURCHASE_UNIT_PRICE,
        PURCHASE_PRICE,
        PROCUREMENT_RETURN_PERIOD,
        ASSET_CLASSIFICATION,
        DEPRECIATION,
        CODING_MODE,
        MAIN_ASSET_CODE,
        SECONDARY,
        LEDGER_ACCOUNT,
        COST_CENTER,
        COST_CENTER_CODE,
        APPLY_USER_CODE
        FROM TB_FA_APPLY_ORDER_DETAIL
		WHERE ID=#{id}
	</select>
	
	<!-- 采购订单页面 选择明细  查询采购申请明细列表 -->
	<select id="searchApplyOrderDetailList" resultMap="applyOrderDetailMap">
		SELECT TD.*
		  FROM TB_FA_APPLY_ORDER T, TB_FA_APPLY_ORDER_DETAIL TD
		 WHERE T.CDOCUMENT = TD.APPLY_ORDER_ID
		<if
			test="ids != null and ids != ''">    
			AND ( TD.NOT_APPLY_COUNT <![CDATA[>]]> 0  
		    OR TD.ID in (${ids})) 
		</if>
		<if
			test="ids == null or ids == ''">  
			AND  TD.NOT_APPLY_COUNT <![CDATA[>]]> 0  	
		</if>
		<if
            test="buyerCode != null and buyerCode != ''">
            AND ( T.BUYER_CODE = #{buyerCode}
           		OR T.BUYER_CODE IN (SELECT CAUTHORIZERCODE FROM T_APPROVALEMPOWER 
										WHERE CUSERCODE = #{buyerCode}  AND SYSDATE BETWEEN CBEGINTIME AND CENDTIME 
										AND CSTATUS='Y' AND CAPPROVALEND='Y')
            )
        </if>
		<if
            test="budgetDepartmentCode != null and budgetDepartmentCode != ''">
            AND T.BUDGET_DEPARTMENT_CODE = #{budgetDepartmentCode}
        </if>
		<if
            test="assetType != null and assetType != ''">
            AND T.ASSET_TYPE = #{assetType}
        </if>
        <if
            test="companyCode != null and companyCode != ''">
            AND T.COMPANY_CODE = #{companyCode}
        </if>
		<if
            test="platform != null and platform != ''">
            AND T.PLATFORM = #{platform}
        </if>
		<if
            test="cdocument != null and cdocument != ''">
            AND TD.APPLY_ORDER_ID LIKE  '%' || #{cdocument} || '%' 
        </if>
		<if
            test="applyUser != null and applyUser != ''">
            AND T.APPLY_USER LIKE  '%' || #{applyUser} || '%' 
        </if>
        <if
			test="applyDateStart != null and applyDateStart != ''">
			AND T.APPLY_DATE <![CDATA[>]]> #{applyDateStart} 
		</if>
		<if
			test="applyDateEnd != null and applyDateEnd != ''">
			AND T.APPLY_DATE <![CDATA[<]]> #{applyDateEnd} 
		</if>
		<if
            test="assetType != null and assetType != ''">
            AND T.ASSET_TYPE = #{assetType}
        </if>
		<if
            test="expensing != null and expensing != ''">
            AND T.EXPENSING = #{expensing}
        </if>
        	AND T.STATUS = 'Y'                      
		   	AND T.DRAFT = 'N'                      
		   	AND T.ORDER_STATUS = '未关闭'                      
		   	AND T.CAPPROVALSTATE = '已完成'      
	</select>
	<update id="writeBack">
		UPDATE TB_FA_APPLY_ORDER_DETAIL
		  SET APPLY_COUNT = APPLY_COUNT+#{applyCount},
		  NOT_APPLY_COUNT = NOT_APPLY_COUNT-#{applyCount}
		  WHERE ID = #{applyDetailId}
	</update>
	<select id="searchApplyOrderDetailById" resultMap="applyOrderDetailMap">
		SELECT T.* FROM TB_FA_APPLY_ORDER_DETAIL T WHERE T.ID = #{id}
	</select>

    <update id="updateApplyOrderDetail">
        UPDATE TB_FA_APPLY_ORDER_DETAIL
        SET
        ASSET_CLASSIFICATION      =  #{applyOrderDetail.assetClassification} ,
        CODING_MODE               = #{applyOrderDetail.codingMode} ,
        MAIN_ASSET_CODE           = #{applyOrderDetail.mainAssetCode} ,
        SECONDARY                 = #{applyOrderDetail.secondary},
        DEPRECIATION              = #{applyOrderDetail.depreciation} ,
        NET_SALVAGE               = #{applyOrderDetail.netSalvage}  ,
        LEDGER_ACCOUNT            = #{applyOrderDetail.ledgerAccount}

        where 1 = 1
        AND ID = #{applyOrderDetail.id}
        AND APPLY_ORDER_ID = #{applyOrder.cdocument}
    </update>
	<update id="updatePurchaseUnitPrice">
        UPDATE TB_FA_APPLY_ORDER_DETAIL
        SET
        PURCHASE_UNIT_PRICE      =  #{applyOrderDetail.purchaseUnitPrice} ,
        PURCHASE_PRICE           =  #{applyOrderDetail.purchasePrice},
        PROCUREMENT_RETURN_PERIOD = #{applyOrderDetail.procurementReturnPeriod}
        where 1 = 1
        AND ID = #{applyOrderDetail.id}
    </update>

    <update id="updateNextSecondaryCoding">
        UPDATE TB_FA_APPLY_ORDER_DETAIL
        SET
        NEXT_SECONDARYCODING      =  #{applyOrderDetail.nextSecondaryCoding}
        where 1 = 1
        AND ID = #{applyOrderDetail.id}
        AND APPLY_ORDER_ID = #{applyOrderDetail.applyOrderId}
    </update>
	 <update id="updateUnits">
        UPDATE TB_FA_APPLY_ORDER_DETAIL
        SET
        UNITS  		 	=  #{units},
        LEDGER_ACCOUNT	=  #{ledgerAccount}, 
        DEPRECIATION	=  #{depreciation},
        ASSET_CLASSIFICATION  =  #{assetClassification}

        where ID = #{id}
    </update>
    <update id="updatePurAvaMoney">
        UPDATE TB_FA_APPLY_ORDER_DETAIL
        SET
        PURCHASE_AVA_MONEY = #{purchaseAvaMoney}

        where ID = #{id}
    </update>

    <resultMap id="demandOrderDetailMap" type="com.opple.fa.purchase.model.DemandOrderDetailModel">
        <result property="id" column="ID" />
        <result property="demandOrderId" column="DEMAND_ORDER_ID" />
        <result property="assetsName" column="ASSETS_NAME" />
        <result property="applyUser" column="APPLY_USER" />
        <result property="demandCount" column="DEMAND_COUNT" />
        <result property="applyCount" column="APPLY_COUNT" />
        <result property="notApplyCount" column="NOT_APPLY_COUNT" />
        <result property="allocationCount" column="ALLOCATION_COUNT" />
        <result property="createBy" column="CREATE_BY" />
        <result property="createDate" column="CREATE_DATE" />
        <result property="updateBy" column="UPDATE_BY" />
        <result property="updateDate" column="UPDATE_DATE" />
        <result property="createByCode" column="CREATE_BY_CODE" />
        <result property="updateByCode" column="UPDATE_BY_CODE" />
        <result property="projectCode" column="PROJECT_CODE" />
        <result property="specificationParameter" column="SPECIFICATION_PARAMETER" />
        <result property="functions" column="FUNCTIONS" />
        <result property="optionalAccessories" column="OPTIONAL_ACCESSORIES" />
        <result property="acceptanceCriteria" column="ACCEPTANCE_CRITERIA" />
        <result property="standardComputer" column="STANDARD_COMPUTER" />
        <result property="referenceUnitPrice" column="REFERENCE_UNIT_PRICE" />
        <result property="referencePrice" column="REFERENCE_PRICE" />
        <result property="referencePriceLocal" column="REFERENCE_PRICE_LOCAL" />
        <result property="inquiryUnitPrice" column="INQUIRY_UNIT_PRICE" />
        <result property="inquiryPrice" column="INQUIRY_PRICE" />
        <result property="requirementsDate" column="REQUIREMENTS_DATE" />
        <result property="costCenter" column="COST_CENTER" />
        <result property="costCenterCode" column="COST_CENTER_CODE" />
        <result property="useDescription" column="USE_DESCRIPTION" />
        <result property="units" column="UNITS" />
        <result property="applyUserCode" column="APPLY_USER_CODE" />
        <result property="applyDepartment" column="APPLY_DEPARTMENT" />
        <result property="applyDepartmentCode" column="APPLY_DEPARTMENT_CODE" />
        <result property="assetType" column="ASSET_TYPE" />
        <result property="avaliableSumMoney" column="AVALIABLE_SUM_MONEY" />
        <result property="budgetYear" column="BUDGET_YEAR"/>
        <result property="budgetAssetsName" column="BUDGET_ASSETS_NAME"/>

        <result property="assetClassification" column="ASSET_CLASSIFICATION" />
        <result property="depreciation" column="DEPRECIATION" />
        <result property="netSalvage" column="NET_SALVAGE" />
        <result property="ledgerAccount" column="LEDGER_ACCOUNT" />
        <result property="avaliableSumMoneyOld" column="AVALIABLE_SUM_MONEY_OLD"/>
    </resultMap>

    <select id="searchApplyDemandMapping" resultMap="demandOrderDetailMap">
        select dod.apply_user,dod.apply_user_code
        from tb_fa_demand_order_detail dod inner join
            (select t.demand_detail_id
              from tb_fa_apply_demand_mapping t where t.apply_id=#{applyId}
            and t.merge_number=#{mergeNumber}) adm
        on adm.demand_detail_id = dod.id
    </select>
</mapper>